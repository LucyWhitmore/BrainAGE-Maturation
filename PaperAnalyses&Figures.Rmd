---
title: "Paper Analyses"
author: "Lucy Whitmore"
date: "5/4/2022"
output: html_document
---


```{r}
knitr::opts_chunk$set(echo = TRUE)

packages <-  c("tidyverse",
               "ggpubr", 
               "apaTables", "MetBrewer",
               "ggseg", "vip", "tidymodels")
if (length(setdiff(packages, rownames(installed.packages()))) > 0) {
  install.packages(setdiff(packages, rownames(installed.packages())))  
}
lapply(packages, library, character.only = TRUE)
```
Load Data
```{r}
# BrainAGE and Behavioral Data - Vlad's Model, Baseline
load("/Volumes/devbrainlab/Lucy/BrainAGE/fyp/BrainagePDSBaseline.Rda")

# BrainAGE and Behavioral Data - Vlad's Model, Follow-Up
load("/Volumes/devbrainlab/Lucy/BrainAGE/fyp/BrainagePDSFollowUp.Rda")

# BrainAGE and Behavioral Data - ABCD Model, Baseline
load("/Volumes/devbrainlab/Lucy/BrainAGE/fyp/ABCDBaselineSample.Rda")



abcd_brainage_baseline <- rio::import("/Volumes/devbrainlab/Lucy/BrainAGE/fyp/ABCDBaselineBrainAgeCorrected.Rda")

#abcd_brainage_baseline <- rio::import("/Volumes/devbrainlab/Lucy/BrainAGE/fyp/BaselineBrainAgeCorrected.Rda")

load("/Volumes/devbrainlab/Lucy/BrainAGE/fyp/Sample1FollowUp.Rda")
load("/Volumes/devbrainlab/Lucy/BrainAGE/fyp/Sample2FollowUp.Rda")

#load("/Volumes/devbrainlab/Lucy/BrainAGE/fyp/abcd_baseline.Rda")
load("/Volumes/devbrainlab/Lucy/BrainAGE/fyp/ABCDBaselineBrainAgeCorrected.Rda")

load("/Volumes/devbrainlab/Lucy/BrainAGE/fyp/FollowUpBrainAgeCorrected.Rda")


load("/Volumes/devbrainlab/Lucy/BrainAGE/fyp/Sample1Baseline.Rda")
load("/Volumes/devbrainlab/Lucy/BrainAGE/fyp/Sample2Baseline.Rda")



# Load Demographics
demographics <- rio::import("/Volumes/devbrainlab/ABCD_Data/ABCD4pt0/pdem02.txt") %>%
  filter(!collection_title=="collection_title") %>% 
  select(src_subject_id, contains("demo_race"), demo_ethn_v2, demo_ethn2_v2, demo_comb_income_v2)
  
  #join once by baseline IDs, then by follow-up (only recorded at one wave)


demographics_baseline <- left_join(brainage_pds_baseline, demographics)


demographics_followup <- left_join(brainage_pds_followup, demographics)

demographics_baseline_abcdmodel <- left_join(abcd_baseline, demographics)



demographics_long <- rio::import("/Volumes/devbrainlab/ABCD_Data/ABCD4pt0/abcd_lpds01.txt") %>%
  filter(!collection_title=="collection_title") %>% 
  select(src_subject_id, eventname, demo_comb_income_v2_l)

demographics_baseline <- left_join(demographics_baseline, demographics_long %>% filter(eventname == "baseline_year_1_arm_1"))


demographics_followup <- left_join(demographics_followup, demographics_long %>% filter(eventname == "2_year_follow_up_y_arm_1"))

demographics_baseline_abcdmodel <- left_join(demographics_baseline_abcdmodel, demographics_long %>% filter(eventname == "baseline_year_1_arm_1"))



```

# Vlad's Model, Baseline Analyses

#Run Models
```{r}
# brainage ~ youth sum
#baseline_puberty_y_sum_1 <- lm(corrected_gap ~ youth_sum, data = sample_1)
#baseline_puberty_y_sum_2 <- lm(corrected_gap ~ youth_sum, data = sample_2)

sample_1_baseline_months <- sample_1_baseline %>% 
  mutate(interview_age_m = interview_age/12)

sample_2_baseline_months <- sample_2_baseline %>% 
  mutate(interview_age_m = interview_age/12)

# brainage ~ youth mean
baseline_puberty_y_mean_1 <- lm(corrected_gap ~ youth_mean, data = sample_1_baseline)
baseline_puberty_y_mean_2 <- lm(corrected_gap ~ youth_mean, data = sample_2_baseline)

baseline_puberty_y_mean_1_m <- lm(corrected_gap ~ youth_mean + interview_age_m, data = sample_1_baseline_months)
baseline_puberty_y_mean_2_m <- lm(corrected_gap ~ youth_mean + interview_age_m, data = sample_2_baseline_months)

#baseline_puberty_y_mean_1_pred <- lm(corrected_pred ~ youth_mean, data = sample_1_baseline)
#baseline_puberty_y_mean_2_pred <- lm(corrected_pred ~ youth_mean, data = sample_2_baseline)

#baseline_puberty_y_mean_1_m_pred <- lm(corrected_pred ~ youth_mean + interview_age_m, data = sample_1_baseline_months)
#baseline_puberty_y_mean_2_m_pred <- lm(corrected_pred ~ youth_mean + interview_age_m, data = sample_2_baseline_months)


# brainage ~ parent sum
#baseline_puberty_p_sum_1 <- lm(corrected_gap ~ parent_sum, data = sample_1)
#baseline_puberty_p_sum_2 <- lm(corrected_gap ~ parent_sum, data = sample_2)

# brainage ~ parent mean
baseline_puberty_p_mean_1 <- lm(corrected_gap ~ parent_mean, data = sample_1_baseline)
baseline_puberty_p_mean_2 <- lm(corrected_gap ~ parent_mean, data = sample_2_baseline)

baseline_puberty_p_mean_1_m <- lm(corrected_gap ~ parent_mean + interview_age_m, data = sample_1_baseline_months)
baseline_puberty_p_mean_2_m <- lm(corrected_gap ~ parent_mean + interview_age_m, data = sample_2_baseline_months)


#Cognition
baseline_cognition_1 <- lm(corrected_gap ~ nihtbx_totalcomp_agecorrected, data=sample_1_baseline)
baseline_cognition_2 <- lm(corrected_gap ~ nihtbx_totalcomp_agecorrected, data=sample_2_baseline)


baseline_cognition_1_m <- lm(corrected_gap ~ nihtbx_totalcomp_agecorrected + interview_age_m, data=sample_1_baseline_months)
baseline_cognition_2_m <- lm(corrected_gap ~ nihtbx_totalcomp_agecorrected + interview_age_m, data=sample_2_baseline_months)

#standard scores
baseline_cognition_standard_1_m <- lm(corrected_gap ~ nihtbx_totalcomp_uncorrected + interview_age_m, data=sample_1_baseline_months)
baseline_cognition_standard_2_m <- lm(corrected_gap ~ nihtbx_totalcomp_uncorrected + interview_age_m, data=sample_2_baseline_months)

#z-scores
baseline_cognition_zscore_1_m <- lm(corrected_gap ~ cog_zscore + interview_age_m, data=sample_1_baseline_months)
baseline_cognition_zscore_2_m <- lm(corrected_gap ~ cog_zscore + interview_age_m, data=sample_2_baseline_months)


#Cognition fluid
#baseline_cognition_fluid_1 <- lm(corrected_gap ~ nihtbx_fluidcomp_agecorrected, data=sample_1)
#baseline_cognition_fluid_2 <- lm(corrected_gap ~ nihtbx_fluidcomp_agecorrected, data=sample_2)

#Cognition crystallized
#baseline_cognition_crystal_1 <- lm(corrected_gap ~ nihtbx_cryst_agecorrected, data=sample_1)
#baseline_cognition_crystal_2 <- lm(corrected_gap ~ nihtbx_cryst_agecorrected, data=sample_2)
```


## Model Summaries
```{r}
summary(baseline_puberty_y_mean_1)
summary(baseline_puberty_y_mean_2)

#summary(baseline_puberty_y_mean_1_pred)
#summary(baseline_puberty_y_mean_2_pred)

summary(baseline_puberty_p_mean_1)
summary(baseline_puberty_p_mean_2)

summary(baseline_cognition_1)
summary(baseline_cognition_2)

summary(baseline_cognition_zscore_1_m)
summary(baseline_cognition_zscore_2_m)

```
Model Summaries of Models w/ age as covariate
```{r}
summary(baseline_puberty_y_mean_1_m)
summary(baseline_puberty_y_mean_2_m)

summary(baseline_puberty_p_mean_1_m)
summary(baseline_puberty_p_mean_2_m)

summary(baseline_cognition_1_m)
summary(baseline_cognition_2_m)

summary(baseline_cognition_standard_1_m)
summary(baseline_cognition_standard_2_m)

```



Basic Prediction Plots
```{r}

df <- ggpredict(baseline_puberty_y_mean_1_m, terms = c("youth_mean","interview_age_m"))
ggplot(df, aes(x, predicted)) + 
    geom_line(aes(linetype=group, color=group)) +
    geom_ribbon(aes(ymin=conf.low, ymax=conf.high, fill=group), alpha=0.15) +
    scale_linetype_manual(values = c("solid", "dashed", "dotted"))



plot_model(baseline_puberty_y_mean_1_m, type="pred", terms = "youth_mean", title = "Predicted Gap", colors = "#cc5968") +
  xlab("Youth-Report Puberty") +
  ylab("Predicted Gap") +
  theme_sjplot()

plot_model(baseline_puberty_y_mean_2_m, type="pred", terms = "youth_mean", title = "Predicted Gap") +
  xlab("Youth-Report Puberty") +
  ylab("Predicted Gap") +
  theme_sjplot()

plot_model(baseline_puberty_p_mean_1_m, type="pred", terms = "parent_mean", title = "Predicted Gap") +
  xlab("Parent-Report Puberty") +
  ylab("Predicted Gap") +
  theme_sjplot()

plot_model(baseline_puberty_p_mean_2_m, type="pred", terms = "parent_mean", title = "Predicted Gap") +
    xlab("Parent-Report Puberty") +
    ylab("Predicted Gap") +
  theme_sjplot()


plot_model(baseline_cognition_1_m, type="pred", terms = "nihtbx_totalcomp_agecorrected", title = "Predicted Gap")+
   xlab("Age-Corrected Cognition Score") +
    ylab("Predicted Gap") +
  theme_sjplot()

plot_model(baseline_cognition_2_m, type="pred", terms = "nihtbx_totalcomp_agecorrected", title = "Predicted Gap")+
    xlab("Age-Corrected Cognition Score") +
    ylab("Predicted Gap") +
  theme_sjplot()



```





Figure 4A from vlad’s paper
Make categorical variables for puberty/cognition just for visualization purposes
Geom_density, fill will be different categories

Density plots
X axis brain age gap
y axis density
grouped/split/colored by categorical

Color Palettes:
- Darker Green for Model 1 Baseline
#CBDFBD
#BED7AC
#A9CA91
#88B668
- Lighter green for Model 1 follow-uop
#DEE7B1
#D4E09B 
#CAD982
#BDCF63
- Pink for Model 2 baseline
#F5BBA3
#F19C79
#ED865A
#A44A3F




Color Palettes v2
233D4D
E76F51
FCCA46
A1C181
619B8A


Green for M1 Baseline
CCDDBB
A4C185  --
A1C181
7CA352
526D37








Blue for M1 Follow-Up


Red/Yellow for m2 baseline

3 plots: youth-report puberty, parent-report puberty, cognition
```{r}
#Youth-Report Puberty
#make categorical variable for puberty
#age-corrected cognition: These are presented as Standard Scores (mean=100, SD=15).
categorical_pds_baseline <-  brainage_pds_baseline %>% 
  mutate(youth_pds_cat=cut(youth_mean, breaks=c(-Inf, 1, 2, 3, Inf), labels=c("1","2","3", "4")),
         parent_pds_cat=cut(parent_mean, breaks=c(-Inf, 1, 2, 3, Inf), labels=c("1","2","3", "4")),
         cognition_cat=cut(nihtbx_totalcomp_uncorrected, breaks=c(-Inf, 85, 115, Inf), labels=c(">-1", "-1-1", ">1")),
         cognition_cat_small=cut(nihtbx_totalcomp_uncorrected, breaks=c(-Inf, 92, 108, Inf), labels=c(">-.5", "-.5-.5", ">.5")),
         cog_quart = cut(nihtbx_totalcomp_uncorrected, quantile(nihtbx_totalcomp_uncorrected, na.rm=T), labels=c("0-25", "25-50", "50-75", "75-100")))
#don't z-score, include more than 1 standard deviation and less than 1 standard deviation (ignore within 1 SD)


ggpar((categorical_pds_baseline %>% 
  filter(!is.na(youth_pds_cat)) %>% 
  ggdensity(x = "corrected_gap", color= "youth_pds_cat", fill= "youth_pds_cat", add="mean", palette = c('#3E502A','#7CA352','#A1C181', '#CCDDBB'))),  #,'#526D37'
  xlab="Brain Age Gap", ylab="Density", legend.title = "Youth-Report PDS") +
  theme(text = element_text(size = 24)) 
ggsave(filename="baseline_youth_pds_mod1.png",
                          width=7, height=4, units='in', dpi=300)

#Parent-Report Puberty
ggpar((categorical_pds_baseline %>% 
  filter(!is.na(parent_pds_cat)) %>% 
ggdensity(x = "corrected_gap", color= "parent_pds_cat", fill= "parent_pds_cat", add="mean", palette = c('#3E502A','#7CA352','#A1C181', '#CCDDBB'))), 
  xlab="Brain Age Gap", ylab="Density", legend.title = "Parent-Report PDS") +
  theme(text = element_text(size = 24)) 
ggsave(filename="baseline_parent_pds_mod1.png",
                          width=7, height=4, units='in', dpi=300)

#Cognition
ggpar((categorical_pds_baseline %>% 
  filter(!is.na(cognition_cat) & cognition_cat!="-1-1" ) %>% 
  ggdensity(x = "corrected_gap", color= "cognition_cat", fill="cognition_cat", add="mean", palette = c('#7CA352',
 '#CCDDBB'))), xlab="Brain Age Gap", ylab="Density", legend.title = "Standardized Cognition")  +
  theme(text = element_text(size = 24)) 


ggpar((categorical_pds_baseline %>% 
  filter(!is.na(cognition_cat)) %>% 
  ggdensity(x = "corrected_gap", color= "cognition_cat", fill="cognition_cat", add="mean")), xlab="Brain Age Gap", ylab="Density", legend.title = "Age-Corrected Cognition")

ggpar((categorical_pds_baseline %>% 
  filter(!is.na(cognition_cat_small)) %>% 
  ggdensity(x = "corrected_gap", color= "cognition_cat_small", fill="cognition_cat_small", add="mean")), xlab="Brain Age Gap", ylab="Density", legend.title = "Age-Corrected Cognition (.5 sd")


#Cognition Quartiles
ggpar((categorical_pds_baseline %>% 
  filter(!is.na(cog_quart) & cog_quart!="25-50" & cog_quart!="50-75" ) %>% 
  ggdensity(x = "corrected_gap", color= "cog_quart", fill="cog_quart", add="mean", palette = c('#7CA352',
 '#CCDDBB'))), xlab="Brain Age Gap", ylab="Density", legend.title = "Cognition (Quartiles)")  +
  theme(text = element_text(size = 24)) 
ggsave(filename="baseline_cognition_mod1.png",
                          width=7, height=4, units='in', dpi=300)




```

Uncorrected Version
```{r}

#Non-bias corrected version
ggpar((categorical_pds_baseline %>% 
  filter(!is.na(youth_pds_cat)) %>% 
  ggdensity(x = "gap", color= "youth_pds_cat", fill= "youth_pds_cat", add="mean")), 
  xlab="Brain Age Gap", ylab="Density", legend.title = "Youth-Report PDS") 

#Parent-Report Puberty
ggpar((categorical_pds_baseline %>% 
  filter(!is.na(parent_pds_cat)) %>% 
ggdensity(x = "gap", color= "parent_pds_cat", fill= "parent_pds_cat", add="mean")), 
  xlab="Brain Age Gap", ylab="Density", legend.title = "Parent-Report PDS") 

#Cognition
ggpar((categorical_pds_baseline %>% 
  filter(!is.na(cognition_cat) & cognition_cat!="-1-1" ) %>% 
  ggdensity(x = "gap", color= "cognition_cat", fill="cognition_cat", add="mean")), xlab="Brain Age Gap", ylab="Density", legend.title = "Cognition - Standard Scores")


ggpar((categorical_pds_baseline %>% 
  filter(!is.na(cognition_cat)) %>% 
  ggdensity(x = "gap", color= "cognition_cat", fill="cognition_cat", add="mean")), xlab="Brain Age Gap", ylab="Density", legend.title = "Cognition - Standard Scores")
```

Demographics for Baseline Sample
```{r}
table(brainage_pds_baseline$sex)

#white
table(demographics_baseline$demo_race_a_p___10)

#black/african-american
table(demographics_baseline$demo_race_a_p___11)

#native american
table(demographics_baseline$demo_race_a_p___12)

#alaska native
table(demographics_baseline$demo_race_a_p___13)

#native hawaiian
table(demographics_baseline$demo_race_a_p___14)

#guamian
table(demographics_baseline$demo_race_a_p___15)

#samoan
table(demographics_baseline$demo_race_a_p___16)

#other pacific islander
table(demographics_baseline$demo_race_a_p___17)

#asian indian
table(demographics_baseline$demo_race_a_p___18)

#chinese
table(demographics_baseline$demo_race_a_p___19)

#filipino
table(demographics_baseline$demo_race_a_p___20)

#japanese
table(demographics_baseline$demo_race_a_p___21)

#korean
table(demographics_baseline$demo_race_a_p___22)

#vietnamese
table(demographics_baseline$demo_race_a_p___23)

#other asian
table(demographics_baseline$demo_race_a_p___24)

#other race
table(demographics_baseline$demo_race_a_p___25)

#don't know
table(demographics_baseline$demo_race_a_p___99)


#hispanic or latino
table(demographics_baseline$demo_ethn_v2)

#family income
table(demographics_baseline$demo_comb_income_v2)


#Overall values
#Non-hispanic white
demographics_baseline %>% 
  filter(demo_race_a_p___10 == 1 & demo_race_a_p___11 != 1 & demo_race_a_p___12 != 1 & demo_race_a_p___13 != 1 & demo_race_a_p___14 != 1 & demo_race_a_p___15 != 1 & demo_race_a_p___16 != 1 & demo_race_a_p___17 != 1 & demo_race_a_p___18 != 1 & demo_race_a_p___19 != 1 & demo_race_a_p___20 != 1 & demo_race_a_p___21 != 1 & demo_race_a_p___22 != 1 & demo_race_a_p___23 != 1 & demo_race_a_p___24 != 1 & demo_race_a_p___25 != 1 & demo_ethn_v2 != 1)

#Non-hispanic Black
demographics_baseline %>% 
  filter(demo_race_a_p___10 != 1 & demo_race_a_p___11 == 1 & demo_race_a_p___12 != 1 & demo_race_a_p___13 != 1 & demo_race_a_p___14 != 1 & demo_race_a_p___15 != 1 & demo_race_a_p___16 != 1 & demo_race_a_p___17 != 1 & demo_race_a_p___18 != 1 & demo_race_a_p___19 != 1 & demo_race_a_p___20 != 1 & demo_race_a_p___21 != 1 & demo_race_a_p___22 != 1 & demo_race_a_p___23 != 1 & demo_race_a_p___24 != 1 & demo_race_a_p___25 != 1 & demo_ethn_v2 != 1)

#Hispanic
demographics_baseline %>% 
  filter(demo_ethn_v2 == 1)

#Asian
demographics_baseline %>% 
  filter(demo_race_a_p___10 != 1 & demo_race_a_p___11 != 1 & demo_race_a_p___12 != 1 & demo_race_a_p___13 != 1 & demo_race_a_p___14 != 1 & demo_race_a_p___15 != 1 & demo_race_a_p___16 != 1 & demo_race_a_p___17 != 1 & ( demo_race_a_p___18 == 1 | demo_race_a_p___19 == 1 | demo_race_a_p___20 == 1 | demo_race_a_p___21 == 1 | demo_race_a_p___22 == 1 | demo_race_a_p___23 == 1 | demo_race_a_p___24 == 1) & demo_race_a_p___25 != 1 & demo_ethn_v2 != 1)

#Native American Alaska Native
demographics_baseline %>% 
  filter(demo_race_a_p___10 != 1 & demo_race_a_p___11 != 1 & (demo_race_a_p___12 ==1 | demo_race_a_p___13 == 1) & demo_race_a_p___14 != 1 & demo_race_a_p___15 != 1 & demo_race_a_p___16 != 1 & demo_race_a_p___17 != 1 & demo_race_a_p___18 != 1 & demo_race_a_p___19 != 1 & demo_race_a_p___20 != 1 & demo_race_a_p___21 != 1 & demo_race_a_p___22 != 1 & demo_race_a_p___23 != 1 & demo_race_a_p___24 != 1 & demo_race_a_p___25 != 1 )


#Multiracial

# mutate column: true if participant marked any asian category
# mutate column: true if participant marked native american/alaska native
# sum white, black, asian, native american/alaska native, and additional races

demographics_baseline %>% 
  mutate_at(c(18:33), as.numeric) %>% 
  mutate(
    demo_race_asian = case_when((demo_race_a_p___18 == 1 | demo_race_a_p___19 == 1 | demo_race_a_p___20 == 1 | demo_race_a_p___21 == 1 | demo_race_a_p___22 == 1 | demo_race_a_p___23 == 1 | demo_race_a_p___24 == 1) ~ 1,
                            (demo_race_a_p___18 != 1 & demo_race_a_p___19 != 1 & demo_race_a_p___20 != 1 & demo_race_a_p___21 != 1 & demo_race_a_p___22 != 1 & demo_race_a_p___23 != 1 & demo_race_a_p___24 != 1) ~ 0),
         demo_race_native_american_alaskan = case_when((demo_race_a_p___12 ==1 | demo_race_a_p___13 == 1) ~ 1,
                                                       (demo_race_a_p___12 !=1 & demo_race_a_p___13 != 1) ~ 0),
         race_total = rowSums(across(c(demo_race_a_p___10, demo_race_a_p___11, demo_race_a_p___14, demo_race_a_p___15, demo_race_a_p___16, demo_race_a_p___17, demo_race_a_p___25, demo_race_asian, demo_race_native_american_alaskan)), na.rm=T)) %>% 
  filter(race_total > 1)


#additional races
#If the caregiver chose Native Hawaiian, Guamanian, or Samoan, Other Race, or refused to choose a racial category, the youth was placed in the “additional” race group as there were too few youth in each of these categories individually for separate analysis.

demographics_baseline %>% 
  filter(demo_race_a_p___10 != 1 & demo_race_a_p___11 == 1 & demo_race_a_p___12 != 1 & demo_race_a_p___13 != 1 & (demo_race_a_p___14 == 1 | demo_race_a_p___15 == 1 | demo_race_a_p___16 == 1 | demo_race_a_p___17 == 1 | demo_race_a_p___25 == 1) & demo_race_a_p___18 != 1 & demo_race_a_p___19 != 1 & demo_race_a_p___20 != 1 & demo_race_a_p___21 != 1 & demo_race_a_p___22 != 1 & demo_race_a_p___23 != 1 & demo_race_a_p___24 != 1)




```


Figure 2
Use subsample, otherwise it’ll look super funky

Scatterplot of scan age/chronological age vs predicted age
2 panels: 1 for validation, 1 for analysis sample
1 or 2 extra panels for analysis sample w/ Vlad's model
```{r}
#subsample data
#sample_n()

ggplot(brainage_pds_baseline, aes(x=truth, y=corrected_pred)) + 
  geom_jitter(color="#A1C181")+
  geom_abline(a=0, b=1, color='#233D4D') +
  #geom_smooth(method=lm, color='#233D4D') +
  labs(x = "Scan/Chronological Age", y ="Predicted Age", title = "Age v Pred Age - Model 1 (Baseline)") +
  theme_classic() + 
  theme(text = element_text(size = 22))  
ggsave(filename="baseline_truth_corrected_pred_mod1.png",
                          width=7, height=4, units='in', dpi=300)



ggscatter(brainage_pds_baseline, x = "truth", y = "gap",
   color = "#00AFBB", # Points color, shape and size
   add = "reg.line",  # Add regression line
   add.params = list(color = "blue", fill = "lightgray")
   )

ggscatter(brainage_pds_baseline, x = "truth", y = "corrected_gap",
   color = "#CBDFBD", # Points color, shape and size
   add = "reg.line",  # Add regressin line
   add.params = list(color = "blue", fill = "lightgray"),
   xlab= "Scan/Chronological Age",
   ylab = "Corrected Gap"
   ) +
  scale_y_continuous(breaks = c(-5, -2.5, 0, 2.5, 5), 
                     labels = c(-5, -2.5, 0, 2.5, 5))


ggplot(brainage_pds_baseline, aes(x=truth, y=corrected_gap)) + 
  geom_jitter(color="#A1C181")+
  geom_smooth(method=lm, color='#233D4D') +
  labs(x = "Scan/Chronological Age", y ="Corrected Gap", title = "Age Bias - Model 1 (Baseline)") +
  theme_classic() + 
  theme(text = element_text(size = 22))  
ggsave(filename="baseline_truth_corrected_gap_mod1.png",
                          width=7, height=4, units='in', dpi=300)
```


Checking Follow-up Brainage

Load Data
```{r}
corrected_followup_brainage <- rio::import("/Volumes/devbrainlab/Lucy/BrainAGE/FYP/FollowUpBrainAgeCorrected.Rda")

load("/Volumes/devbrainlab/Lucy/BrainAGE/FYP/BrainagePDSFollowUp.Rda")

#corrected_followup_brainage$src_subject_id <- smri_followup$src_subject_id

```

```{r}
ggpar((corrected_baseline_brainage %>% 
  #filter(!is.na(youth_pds_cat)) %>% 
  ggdensity(x = "corrected_gap", add="mean")), 
  xlab="Brain Age Gap", ylab="Density", legend.title = "Baseline") 

ggpar((corrected_followup_brainage %>% 
  #filter(!is.na(youth_pds_cat)) %>% 
  ggdensity(x = "corrected_gap", add="mean")), 
  xlab="Brain Age Gap", ylab="Density", legend.title = "Follow-Up") 


# Actual vs Corrected Predictions, w/ perfect correlation line

ggplot(brainage_pds_followup, aes(x=truth, y=corrected_pred)) + 
  geom_jitter(color="#619B8A")+
  geom_abline(a=0, b=1, color='#233D4D') +
  labs(x = "Scan/Chronological Age", y ="Predicted Age", title = "Age v Pred Age - Model 1 (Follow-Up)") +
  theme_classic() + 
  theme(text = element_text(size = 22))  
ggsave(filename="followup_truth_corrected_pred_mod1.png",
                          width=7, height=4, units='in', dpi=300)



# Age Bias - truth vs corrected gap
ggplot(brainage_pds_followup, aes(x=truth, y=corrected_gap)) + 
  geom_jitter(color="#619B8A")+
  geom_smooth(method=lm, color='#233D4D') +
  labs(x = "Scan/Chronological Age", y ="Corrected Gap", title = "Age Bias - Model 1 (Follow-Up)") +
  theme_classic() + 
  theme(text = element_text(size = 22))  
ggsave(filename="followup_truth_corrected_gap_mod1.png",
                          width=7, height=4, units='in', dpi=300)

ggscatter(corrected_followup_brainage, x = "truth", y = "gap",
   color = "#00AFBB", # Points color, shape and size
   add = "reg.line",  # Add regressin line
   add.params = list(color = "blue", fill = "lightgray"), # Customize reg. line
   conf.int = TRUE # Add confidence interval
   )


#Fit Metrics

#baseline uncorrected
corrected_baseline_brainage %>%
  metrics(truth = truth, estimate = .pred)
#baseline corrected
corrected_baseline_brainage %>%
  metrics(truth = truth, estimate = corrected_pred)

#follow-up uncorrected
#corrected_followup_brainage %>%
#  metrics(truth = truth, estimate = .pred)
#follow-up corrected
#corrected_followup_brainage %>%
#  metrics(truth = truth, estimate = corrected_pred)


#follow-up uncorrected
brain_age_corrected_df_followup %>%
  metrics(truth = truth, estimate = .pred)
#follow-up corrected
brain_age_corrected_df_followup%>%
  metrics(truth = truth, estimate = corrected_pred)


```



### Follow-Up Analyses

```{r}
#Convert ages to months
sample_1_followup_months <- sample_1_followup %>% 
  mutate(interview_age_m = interview_age/12)

sample_2_followup_months <- sample_2_followup %>% 
  mutate(interview_age_m = interview_age/12)

# brainage ~ youth mean
followup_puberty_y_mean_1 <- lm(corrected_gap ~ youth_mean + interview_age_m, data = sample_1_followup_months)
followup_puberty_y_mean_2 <- lm(corrected_gap ~ youth_mean + interview_age_m, data = sample_2_followup_months)


# brainage ~ parent mean
followup_puberty_p_mean_1 <- lm(corrected_gap ~ parent_mean + interview_age_m, data = sample_1_followup_months)
followup_puberty_p_mean_2 <- lm(corrected_gap ~ parent_mean + interview_age_m, data = sample_2_followup_months)


#Cognition crystallized
followup_cognition_crystal_1 <- lm(corrected_gap ~ nihtbx_cryst_agecorrected, data=sample_1_followup)
followup_cognition_crystal_2 <- lm(corrected_gap ~ nihtbx_cryst_agecorrected, data=sample_2_followup)

# brainage ~ GISH2
```

## Model Summaries
```{r}
summary(followup_puberty_y_mean_1)
summary(followup_puberty_y_mean_2)


summary(followup_puberty_p_mean_1)
summary(followup_puberty_p_mean_2)

summary(followup_cognition_crystal_1)
summary(followup_cognition_crystal_2)
```


# Density Plots for Follow-Up
```{r}
#Youth-Report Puberty
#make categorical variable for puberty
#age-corrected cognition: These are presented as Standard Scores (mean=100, SD=15).
categorical_pds_followup <-  brainage_pds_followup %>% 
  mutate(youth_pds_cat=cut(youth_mean, breaks=c(-Inf, 1, 2, 3, Inf), labels=c("1","2","3", "4")),
         parent_pds_cat=cut(parent_mean, breaks=c(-Inf, 1, 2, 3, Inf), labels=c("1","2","3", "4")))

#don't z-score, include more than 1 standard deviation and less than 1 standard deviation (ignore within 1 SD)


ggpar((categorical_pds_followup %>% 
  filter(!is.na(youth_pds_cat)) %>% 
  ggdensity(x = "corrected_gap", color= "youth_pds_cat", fill= "youth_pds_cat", add="mean", palette=c('#B4D0C7','#82B0A2', '#619B8A', '#568A7B'))), 
  xlab="Brain Age Gap", ylab="Density", legend.title = "Youth-Report PDS")  +
  theme(text = element_text(size = 24)) 

ggsave(filename="followup_youth_pds_mod1.png",
                          width=7, height=4, units='in', dpi=300)

#Parent-Report Puberty
ggpar((categorical_pds_followup %>% 
  filter(!is.na(parent_pds_cat)) %>% 
ggdensity(x = "corrected_gap", color= "parent_pds_cat", fill= "parent_pds_cat", add="mean", palette=c('#B4D0C7','#82B0A2', '#619B8A', '#568A7B'))), 
  xlab="Brain Age Gap", ylab="Density", legend.title = "Parent-Report PDS")  +
  theme(text = element_text(size = 24)) 

ggsave(filename="followup_parent_pds_mod1.png",
                          width=7, height=4, units='in', dpi=300)
```

Uncorrected version
```{r}
#Non-bias corrected version
ggpar((categorical_pds_baseline %>% 
  filter(!is.na(youth_pds_cat)) %>% 
  ggdensity(x = "gap", color= "youth_pds_cat", fill= "youth_pds_cat", add="mean")), 
  xlab="Brain Age Gap", ylab="Density", legend.title = "Youth-Report PDS") 

#Parent-Report Puberty
ggpar((categorical_pds_baseline %>% 
  filter(!is.na(parent_pds_cat)) %>% 
ggdensity(x = "gap", color= "parent_pds_cat", fill= "parent_pds_cat", add="mean")), 
  xlab="Brain Age Gap", ylab="Density", legend.title = "Parent-Report PDS") 

#Cognition
ggpar((categorical_pds_baseline %>% 
  filter(!is.na(cognition_cat) & cognition_cat!="-1-1" ) %>% 
  ggdensity(x = "gap", color= "cognition_cat", fill="cognition_cat", add="mean")), xlab="Brain Age Gap", ylab="Density", legend.title = "Cognition - Standard Scores")


ggpar((categorical_pds_baseline %>% 
  filter(!is.na(cognition_cat)) %>% 
  ggdensity(x = "gap", color= "cognition_cat", fill="cognition_cat", add="mean")), xlab="Brain Age Gap", ylab="Density", legend.title = "Cognition - Standard Scores")

```


Demographics for Follow-Up
```{r}
table(brainage_pds_followup$sex)

#white
table(demographics_followup$demo_race_a_p___10)

#black/african-american
table(demographics_followup$demo_race_a_p___11)

#native american
table(demographics_followup$demo_race_a_p___12)

#alaska native
table(demographics_followup$demo_race_a_p___13)

#native hawaiian
table(demographics_followup$demo_race_a_p___14)

#guamian
table(demographics_followup$demo_race_a_p___15)

#samoan
table(demographics_followup$demo_race_a_p___16)

#other pacific islander
table(demographics_followup$demo_race_a_p___17)

#asian indian
table(demographics_followup$demo_race_a_p___18)

#chinese
table(demographics_followup$demo_race_a_p___19)

#filipino
table(demographics_followup$demo_race_a_p___20)

#japanese
table(demographics_followup$demo_race_a_p___21)

#korean
table(demographics_followup$demo_race_a_p___22)

#vietnamese
table(demographics_followup$demo_race_a_p___23)

#other asian
table(demographics_followup$demo_race_a_p___24)

#other race
table(demographics_followup$demo_race_a_p___25)

#don't know
table(demographics_followup$demo_race_a_p___99)


#hispanic or latino
table(demographics_followup$demo_ethn_v2)

#income
table(demographics_followup$demo_comb_income_v2_l)


#Overall values

#Non-hispanic white
demographics_followup %>% 
  filter(demo_race_a_p___10 == 1 & demo_race_a_p___11 != 1 & demo_race_a_p___12 != 1 & demo_race_a_p___13 != 1 & demo_race_a_p___14 != 1 & demo_race_a_p___15 != 1 & demo_race_a_p___16 != 1 & demo_race_a_p___17 != 1 & demo_race_a_p___18 != 1 & demo_race_a_p___19 != 1 & demo_race_a_p___20 != 1 & demo_race_a_p___21 != 1 & demo_race_a_p___22 != 1 & demo_race_a_p___23 != 1 & demo_race_a_p___24 != 1 & demo_race_a_p___25 != 1 & demo_ethn_v2 != 1)

#Non-hispanic Black
demographics_followup %>% 
  filter(demo_race_a_p___10 != 1 & demo_race_a_p___11 == 1 & demo_race_a_p___12 != 1 & demo_race_a_p___13 != 1 & demo_race_a_p___14 != 1 & demo_race_a_p___15 != 1 & demo_race_a_p___16 != 1 & demo_race_a_p___17 != 1 & demo_race_a_p___18 != 1 & demo_race_a_p___19 != 1 & demo_race_a_p___20 != 1 & demo_race_a_p___21 != 1 & demo_race_a_p___22 != 1 & demo_race_a_p___23 != 1 & demo_race_a_p___24 != 1 & demo_race_a_p___25 != 1 & demo_ethn_v2 != 1)

#Hispanic
demographics_followup %>% 
  filter(demo_ethn_v2 == 1)

#Asian
demographics_followup %>% 
  filter(demo_race_a_p___10 != 1 & demo_race_a_p___11 != 1 & demo_race_a_p___12 != 1 & demo_race_a_p___13 != 1 & demo_race_a_p___14 != 1 & demo_race_a_p___15 != 1 & demo_race_a_p___16 != 1 & demo_race_a_p___17 != 1 & ( demo_race_a_p___18 == 1 | demo_race_a_p___19 == 1 | demo_race_a_p___20 == 1 | demo_race_a_p___21 == 1 | demo_race_a_p___22 == 1 | demo_race_a_p___23 == 1 | demo_race_a_p___24 == 1) & demo_race_a_p___25 != 1 & demo_ethn_v2 != 1)

#Native American Alaska Native
demographics_followup %>% 
  filter(demo_race_a_p___10 != 1 & demo_race_a_p___11 != 1 & (demo_race_a_p___12 ==1 | demo_race_a_p___13 == 1) & demo_race_a_p___14 != 1 & demo_race_a_p___15 != 1 & demo_race_a_p___16 != 1 & demo_race_a_p___17 != 1 & demo_race_a_p___18 != 1 & demo_race_a_p___19 != 1 & demo_race_a_p___20 != 1 & demo_race_a_p___21 != 1 & demo_race_a_p___22 != 1 & demo_race_a_p___23 != 1 & demo_race_a_p___24 != 1 & demo_race_a_p___25 != 1 )


#Multiracial
# mutate column: true if participant marked any asian category
# mutate column: true if participant marked native american/alaska native
# sum white, black, asian, native american/alaska native, and additional races

demographics_followup %>% 
  mutate_at(c(17:32), as.numeric) %>% 
  mutate(
    demo_race_asian = case_when((demo_race_a_p___18 == 1 | demo_race_a_p___19 == 1 | demo_race_a_p___20 == 1 | demo_race_a_p___21 == 1 | demo_race_a_p___22 == 1 | demo_race_a_p___23 == 1 | demo_race_a_p___24 == 1) ~ 1,
                            (demo_race_a_p___18 != 1 & demo_race_a_p___19 != 1 & demo_race_a_p___20 != 1 & demo_race_a_p___21 != 1 & demo_race_a_p___22 != 1 & demo_race_a_p___23 != 1 & demo_race_a_p___24 != 1) ~ 0),
         demo_race_native_american_alaskan = case_when((demo_race_a_p___12 ==1 | demo_race_a_p___13 == 1) ~ 1,
                                                       (demo_race_a_p___12 !=1 & demo_race_a_p___13 != 1) ~ 0),
         race_total = rowSums(across(c(demo_race_a_p___10, demo_race_a_p___11, demo_race_a_p___14, demo_race_a_p___15, demo_race_a_p___16, demo_race_a_p___17, demo_race_a_p___25, demo_race_asian, demo_race_native_american_alaskan)), na.rm=T)) %>% 
  filter(race_total > 1)


#additional races
#If the caregiver chose Native Hawaiian, Guamanian, or Samoan, Other Race, or refused to choose a racial category, the youth was placed in the “additional” race group as there were too few youth in each of these categories individually for separate analysis.

demographics_followup %>% 
  filter(demo_race_a_p___10 != 1 & demo_race_a_p___11 == 1 & demo_race_a_p___12 != 1 & demo_race_a_p___13 != 1 & (demo_race_a_p___14 == 1 | demo_race_a_p___15 == 1 | demo_race_a_p___16 == 1 | demo_race_a_p___17 == 1 | demo_race_a_p___25 == 1) & demo_race_a_p___18 != 1 & demo_race_a_p___19 != 1 & demo_race_a_p___20 != 1 & demo_race_a_p___21 != 1 & demo_race_a_p___22 != 1 & demo_race_a_p___23 != 1 & demo_race_a_p___24 != 1)



```

##### ABCD Model #####

Check on talapas model output
```{r}
abcd_model_5_9 <- rio::import("/Volumes/devbrainlab/Lucy/BrainAGE/FYP/xgboost_abcd_brain_age_mod_5_9.rds")

abcd_model_5_9 <- readRDS("/Volumes/devbrainlab/Lucy/BrainAGE/FYP/xgboost_abcd_brain_age_mod_5_9.rds")


abcd_model_multiwave <- readRDS("/Volumes/devbrainlab/Lucy/BrainAGE/FYP/xgboost_abcd_multiwave_brain_age_mod.rds")

xgb.save(abcd_model_5_9, 'abcd_model_5_9.json')

save(abcd_model_5_9, abcd_model_5_9.RData)

xgb.load("/Volumes/devbrainlab/Lucy/BrainAGE/FYP/xgboost_abcd_brain_age_mod_5_9.rds")

xgb.serialize(abcd_model_5_9)

xgb.Booster.complete(abcd_model_5_9)

config <- xgb.config(abcd_model_5_9)
print(config)

bst <- xgboost::xgb.Booster("/Volumes/devbrainlab/Lucy/BrainAGE/FYP/xgboost_abcd_brain_age_mod_5_9.rds")



abcd_model_59 <- readRDS("~/Desktop/xgboost_abcd_brain_age_mod_5_9.rds")




abcd_model_4_22 <- rio::import("/Volumes/devbrainlab/Lucy/BrainAGE/FYP/xgboost_abcd_brain_age_mod.rds")
```

Plots & Decriptives for ABCD Model
```{r}
describe(abcd_brainage_baseline)
#describe(abcd_brainage_baseline %>% filter(truth != 9))
#describe(abcd_brainage_baseline %>% filter(between(truth, 9, 9.2)))

#Fit Metrics
#baseline uncorrected
abcd_brainage_baseline %>%
  metrics(truth = truth, estimate = .pred)
#baseline corrected
abcd_brainage_baseline  %>%
  metrics(truth = truth, estimate = corrected_pred)



ggscatter(abcd_brainage_baseline, x = "truth", y = ".pred",
   color = "#00AFBB", # Points color, shape and size
   add = "reg.line",  # Add regressin line
   add.params = list(color = "blue", fill = "lightgray"), # Customize reg. line
   conf.int = TRUE # Add confidence interval
   )


ggscatter(abcd_brainage_baseline, x = "truth", y = "gap",
   color = "#00AFBB", # Points color, shape and size
   add = "reg.line",  # Add regressin line
   add.params = list(color = "blue", fill = "lightgray"), # Customize reg. line
   conf.int = TRUE # Add confidence interval
   )



# Actual vs Corrected Predictions, w/ perfect correlation line

ggplot(abcd_brainage_baseline, aes(x=truth, y=corrected_pred)) + 
  geom_jitter(color="#E76F51")+
  geom_abline(a=0, b=1, color='#233D4D') +
  labs(x = "Scan/Chronological Age", y ="Predicted Age", title = "Age v Pred Age - Model 2 (Baseline)") +
  theme_classic() + 
  theme(text = element_text(size = 22))  
ggsave(filename="baseline_truth_corrected_pred_mod2.png",
                          width=7, height=4, units='in', dpi=300)



# Age Bias - truth vs corrected gap
ggplot(abcd_brainage_baseline, aes(x=truth, y=corrected_gap)) + 
  geom_jitter(color="#E76F51")+
  geom_smooth(method=lm, color='#233D4D') +
  labs(x = "Scan/Chronological Age", y ="Corrected Gap", title = "Age Bias - Model 2 (Baseline)") +
  theme_classic() + 
  theme(text = element_text(size = 22))  
ggsave(filename="baseline_truth_corrected_gap_mod2.png",
                          width=7, height=4, units='in', dpi=300)




hist(abcd_brainage_baseline$truth)


```
ggseg ones with weightings for the model
New model only 

4 panels:
cortical map and bar graph
subcortical map and bar graph

stacked bar plot with right hemisphere followed by left hemisphere where applicable.
^note: how to decide top 10> top 10 by hemisphere and then add other hemisphere, or top 10 by bilateral calculation?

vip package
```{r}
# Calculate variables of importance
abcd_vi <- vi(abcd_model_5_9) #xgb_final_mod, xgboost_abcd_brain_age_mod
abcd_vi

abcd_vi <- vi(abcd_model_59) #xgb_final_mod, xgboost_abcd_brain_age_mod
abcd_vi

xgboost::xgb.importance(model=abcd_model_5_9)



vip(abcd_model_5_9, num_features = 20)  +
  theme_light()

vip(abcd_model_59, num_features = 20)  +
  theme_light()

#Subset so that we don't have to rename all?

# Rename columns to fit with ggseg atlas (ugghhh)

brain_regions(dk)
brain_labels(dk)

brain_labels(aseg)

ggseg(abcd_vi)


#Actually plot
#Cortical
abcd_vi %>%
  ggplot() +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = Importance))
#Subcortical
abcd_vi %>%
  ggplot() +
  geom_brain(atlas = aseg, 
             position = position_brain(hemi ~ side),
             aes(fill = Importance))
```


#### ABCD Model - Baseline
```{r}
abcd_baseline_months <- abcd_baseline %>% 
  mutate(interview_age_m = interview_age/12)

# brainage ~ youth sum
abcd_baseline_puberty_y_sum <- lm(corrected_gap ~ youth_sum + interview_age_m, data = abcd_baseline_months)

# brainage ~ youth mean
abcd_baseline_puberty_y_mean <- lm(corrected_gap ~ youth_mean+ interview_age_m, data = abcd_baseline_months)
#abcd_baseline_puberty_y_mean_noage <- lm(corrected_gap ~ youth_mean, data = abcd_baseline_months)

# brainage ~ parent sum
abcd_baseline_puberty_p_sum <- lm(corrected_gap ~ parent_sum + interview_age_m, data = abcd_baseline_months)

# brainage ~ parent mean
abcd_baseline_puberty_p_mean <- lm(corrected_gap ~ parent_mean + interview_age_m, data = abcd_baseline_months)
#abcd_baseline_puberty_p_mean_noage <- lm(corrected_gap ~ parent_mean, data = abcd_baseline_months)

#Cognition
abcd_baseline_cognition <- lm(corrected_gap ~ nihtbx_totalcomp_agecorrected+ interview_age_m, data=abcd_baseline_months)

abcd_baseline_cognition_standard <- lm(corrected_gap ~ nihtbx_totalcomp_uncorrected + interview_age_m, data=abcd_baseline_months)

abcd_baseline_cognition_standard_noage <- lm(corrected_gap ~ nihtbx_totalcomp_uncorrected, data=abcd_baseline_months)

#Cognition fluid
#abcd_baseline_cognition_fluid <- lm(corrected_gap ~ nihtbx_fluidcomp_agecorrected, data=abcd_baseline_months)

#Cognition crystallized
#abcd_baseline_cognition_crystal <- lm(corrected_gap ~ nihtbx_cryst_agecorrected, data=abcd_baseline_months)
```




## Model Summaries
```{r}
summary(abcd_baseline_puberty_y_mean)

#summary(abcd_baseline_puberty_y_sum)

summary(abcd_baseline_puberty_p_mean)

#summary(abcd_baseline_puberty_p_sum)

#summary(abcd_baseline_cognition_crystal)

#summary(abcd_baseline_cognition_fluid)

summary(abcd_baseline_cognition)

summary(abcd_baseline_cognition_standard)


```
Model Plots
```{r}
#Cognition
ggPredict(abcd_baseline_cognition_standard,se=TRUE)

```

ABCD Baseline Model
```{r}
#Youth-Report Puberty
#make categorical variable for puberty
#age-corrected cognition: These are presented as Standard Scores (mean=100, SD=15).
abcd_baseline_categorical_pds <- abcd_baseline %>% 
  mutate(youth_pds_cat=cut(youth_mean, breaks=c(-Inf, 1, 2, 3, Inf), labels=c("1","2","3", "4")),
         parent_pds_cat=cut(parent_mean, breaks=c(-Inf, 1, 2, 3, Inf), labels=c("1","2","3", "4")),
         cognition_cat=cut(nihtbx_totalcomp_uncorrected, breaks=c(-Inf, 85, 115, Inf), labels=c(">-1", "-1-1", ">1")),
         cognition_cat_small=cut(nihtbx_totalcomp_uncorrected, breaks=c(-Inf, 92, 108, Inf), labels=c(">-.5", "-.5-.5", ">.5")),
         cog_quart = cut(nihtbx_totalcomp_uncorrected, quantile(nihtbx_totalcomp_uncorrected, na.rm=T), labels=c("0-25", "25-50", "50-75", "75-100")))

#don't z-score, include more than 1 standard deviation and less than 1 standard deviation (ignore within 1 SD)

#Youth-report puberty
ggpar((abcd_baseline_categorical_pds %>% 
  filter(!is.na(youth_pds_cat)) %>% 
  ggdensity(x = "corrected_gap", color= "youth_pds_cat", fill= "youth_pds_cat", add="mean", palette=c('#FCCA46','#F3B5A5', '#E76F51', '#B43718'))), 
  xlab="Brain Age Gap", ylab="Density", legend.title = "Youth-Report PDS")  +
  theme(text = element_text(size = 24)) 

ggsave(filename="baseline_youth_pds_mod2.png",
                          width=7, height=4, units='in', dpi=300)

#Parent-Report Puberty
ggpar((abcd_baseline_categorical_pds %>% 
  filter(!is.na(parent_pds_cat)) %>% 
ggdensity(x = "corrected_gap", color= "parent_pds_cat", fill= "parent_pds_cat", add="mean", palette=c('#FCCA46','#F3B5A5', '#E76F51', '#B43718'))), 
  xlab="Brain Age Gap", ylab="Density", legend.title = "Parent-Report PDS")  +
  theme(text = element_text(size = 24)) 
ggsave(filename="baseline_parent_pds_mod2.png",
                          width=7, height=4, units='in', dpi=300)

ggpar((abcd_baseline_categorical_pds %>% 
  filter(!is.na(cognition_cat)) %>% 
  ggdensity(x = "corrected_gap", color= "cognition_cat", fill="cognition_cat", add="mean", palette=c('#FCCA46',
 '#E76F51'))), xlab="Brain Age Gap", ylab="Density", legend.title = "Cognition (Standard Scores") +
  theme(text = element_text(size = 24)) 

ggpar((abcd_baseline_categorical_pds %>% 
  filter(!is.na(cognition_cat)) %>% 
  ggdensity(x = "corrected_gap", color= "cognition_cat_small", fill="cognition_cat_small", add="mean")), xlab="Brain Age Gap", ylab="Density", legend.title = "Cognition (Standard Scores) .5 SD") +
  theme(text = element_text(size = 24)) 

#Cognition Quartiles
ggpar((abcd_baseline_categorical_pds %>% 
  filter(!is.na(cog_quart) & cog_quart!="25-50" & cog_quart!="50-75" ) %>% 
  ggdensity(x = "corrected_gap", color= "cog_quart", fill="cog_quart", add="mean", palette = c('#FCCA46',
 '#E76F51'))), xlab="Brain Age Gap", ylab="Density", legend.title = "Cognition (Quartiles)")  +
  theme(text = element_text(size = 24)) 
ggsave(filename="baseline_cognition_mod2.png",
                          width=7, height=4, units='in', dpi=300)

```

Demographics for ABCD Baseline
```{r}
table(demographics_baseline_abcdmodel$sex)

#white
table(demographics_baseline_abcdmodel$demo_race_a_p___10)

#black/african-american
table(demographics_baseline_abcdmodel$demo_race_a_p___11)

#native american
table(demographics_baseline_abcdmodel$demo_race_a_p___12)

#alaska native
table(demographics_baseline_abcdmodel$demo_race_a_p___13)

#native hawaiian
table(demographics_baseline_abcdmodel$demo_race_a_p___14)

#guamian
table(demographics_baseline_abcdmodel$demo_race_a_p___15)

#samoan
table(demographics_baseline_abcdmodel$demo_race_a_p___16)

#other pacific islander
table(demographics_baseline_abcdmodel$demo_race_a_p___17)

#asian indian
table(demographics_baseline_abcdmodel$demo_race_a_p___18)

#chinese
table(demographics_baseline_abcdmodel$demo_race_a_p___19)

#filipino
table(demographics_baseline_abcdmodel$demo_race_a_p___20)

#japanese
table(demographics_baseline_abcdmodel$demo_race_a_p___21)

#korean
table(demographics_baseline_abcdmodel$demo_race_a_p___22)

#vietnamese
table(demographics_baseline_abcdmodel$demo_race_a_p___23)

#other asian
table(demographics_baseline_abcdmodel$demo_race_a_p___24)

#other race
table(demographics_baseline_abcdmodel$demo_race_a_p___25)

#don't know
table(demographics_baseline_abcdmodel$demo_race_a_p___99)


#hispanic or latino
table(demographics_baseline_abcdmodel$demo_ethn_v2)


#income
table(demographics_baseline_abcdmodel$demo_comb_income_v2)


# calculate overall values
#Overall values
#Non-hispanic white
demographics_baseline_abcdmodel %>% 
  filter(demo_race_a_p___10 == 1 & demo_race_a_p___11 != 1 & demo_race_a_p___12 != 1 & demo_race_a_p___13 != 1 & demo_race_a_p___14 != 1 & demo_race_a_p___15 != 1 & demo_race_a_p___16 != 1 & demo_race_a_p___17 != 1 & demo_race_a_p___18 != 1 & demo_race_a_p___19 != 1 & demo_race_a_p___20 != 1 & demo_race_a_p___21 != 1 & demo_race_a_p___22 != 1 & demo_race_a_p___23 != 1 & demo_race_a_p___24 != 1 & demo_race_a_p___25 != 1 & demo_ethn_v2 != 1)

#Non-hispanic Black
demographics_baseline_abcdmodel%>% 
  filter(demo_race_a_p___10 != 1 & demo_race_a_p___11 == 1 & demo_race_a_p___12 != 1 & demo_race_a_p___13 != 1 & demo_race_a_p___14 != 1 & demo_race_a_p___15 != 1 & demo_race_a_p___16 != 1 & demo_race_a_p___17 != 1 & demo_race_a_p___18 != 1 & demo_race_a_p___19 != 1 & demo_race_a_p___20 != 1 & demo_race_a_p___21 != 1 & demo_race_a_p___22 != 1 & demo_race_a_p___23 != 1 & demo_race_a_p___24 != 1 & demo_race_a_p___25 != 1 & demo_ethn_v2 != 1)

#Hispanic
demographics_baseline_abcdmodel %>% 
  filter(demo_ethn_v2 == 1)

#Asian
demographics_baseline_abcdmodel %>% 
  filter(demo_race_a_p___10 != 1 & demo_race_a_p___11 != 1 & demo_race_a_p___12 != 1 & demo_race_a_p___13 != 1 & demo_race_a_p___14 != 1 & demo_race_a_p___15 != 1 & demo_race_a_p___16 != 1 & demo_race_a_p___17 != 1 & ( demo_race_a_p___18 == 1 | demo_race_a_p___19 == 1 | demo_race_a_p___20 == 1 | demo_race_a_p___21 == 1 | demo_race_a_p___22 == 1 | demo_race_a_p___23 == 1 | demo_race_a_p___24 == 1) & demo_race_a_p___25 != 1 & demo_ethn_v2 != 1)

#Native American Alaska Native
demographics_baseline_abcdmodel %>% 
  filter(demo_race_a_p___10 != 1 & demo_race_a_p___11 != 1 & (demo_race_a_p___12 ==1 | demo_race_a_p___13 == 1) & demo_race_a_p___14 != 1 & demo_race_a_p___15 != 1 & demo_race_a_p___16 != 1 & demo_race_a_p___17 != 1 & demo_race_a_p___18 != 1 & demo_race_a_p___19 != 1 & demo_race_a_p___20 != 1 & demo_race_a_p___21 != 1 & demo_race_a_p___22 != 1 & demo_race_a_p___23 != 1 & demo_race_a_p___24 != 1 & demo_race_a_p___25 != 1 )


#Multiracial
#Multiracial

# mutate column: true if participant marked any asian category
# mutate column: true if participant marked native american/alaska native
# sum white, black, asian, native american/alaska native, and additional races

demographics_baseline_abcdmodel %>% 
  mutate_at(c(18:33), as.numeric) %>% 
  mutate(
    demo_race_asian = case_when((demo_race_a_p___18 == 1 | demo_race_a_p___19 == 1 | demo_race_a_p___20 == 1 | demo_race_a_p___21 == 1 | demo_race_a_p___22 == 1 | demo_race_a_p___23 == 1 | demo_race_a_p___24 == 1) ~ 1,
                            (demo_race_a_p___18 != 1 & demo_race_a_p___19 != 1 & demo_race_a_p___20 != 1 & demo_race_a_p___21 != 1 & demo_race_a_p___22 != 1 & demo_race_a_p___23 != 1 & demo_race_a_p___24 != 1) ~ 0),
         demo_race_native_american_alaskan = case_when((demo_race_a_p___12 ==1 | demo_race_a_p___13 == 1) ~ 1,
                                                       (demo_race_a_p___12 !=1 & demo_race_a_p___13 != 1) ~ 0),
         race_total = rowSums(across(c(demo_race_a_p___10, demo_race_a_p___11, demo_race_a_p___14, demo_race_a_p___15, demo_race_a_p___16, demo_race_a_p___17, demo_race_a_p___25, demo_race_asian, demo_race_native_american_alaskan)), na.rm=T)) %>% 
  filter(race_total > 1)


#additional races
#If the caregiver chose Native Hawaiian, Guamanian, or Samoan, Other Race, or refused to choose a racial category, the youth was placed in the “additional” race group as there were too few youth in each of these categories individually for separate analysis.

demographics_baseline_abcdmodel %>% 
  filter(demo_race_a_p___10 != 1 & demo_race_a_p___11 == 1 & demo_race_a_p___12 != 1 & demo_race_a_p___13 != 1 & (demo_race_a_p___14 == 1 | demo_race_a_p___15 == 1 | demo_race_a_p___16 == 1 | demo_race_a_p___17 == 1 | demo_race_a_p___25 == 1) & demo_race_a_p___18 != 1 & demo_race_a_p___19 != 1 & demo_race_a_p___20 != 1 & demo_race_a_p___21 != 1 & demo_race_a_p___22 != 1 & demo_race_a_p___23 != 1 & demo_race_a_p___24 != 1)




```


Examining correlation between vlad's model and abcd model
```{r}

abcd_brainage_baseline$src_subject_id <- sample_2$src_subject_id

model_compare <- abcd_brainage_baseline %>% 
  rename(.pred_abcd = .pred,
         truth_abcd = truth,
        gap_abcd = gap,
        corrected_pred_abcd = corrected_pred,
        corrected_gap_abcd = corrected_gap) %>% 
    left_join(sample_2)

ggscatter(model_compare, x = "corrected_gap", y = "corrected_gap_abcd",
   color = "#00AFBB", # Points color, shape and size
   add = "reg.line",  # Add regressin line
   add.params = list(color = "blue", fill = "lightgray"), # Customize reg. line
   conf.int = TRUE # Add confidence interval
   )

ggscatter(model_compare, x = "corrected_pred", y = "corrected_pred_abcd",
   color = "#00AFBB", # Points color, shape and size
   add = "reg.line",  # Add regressin line
   add.params = list(color = "blue", fill = "lightgray"), # Customize reg. line
   conf.int = TRUE # Add confidence interval
   )


cor.test(model_compare$truth, model_compare$corrected_gap_abcd)

cor.test(model_compare$truth, model_compare$corrected_gap)


#Correlation between same participants across models
cor(model_compare$corrected_gap, model_compare$corrected_gap_abcd)

```



###########
Combined Wave Model
###########
```{r}
#Fit Metrics
#baseline uncorrected
abcd_brainage_multiwave %>%
  metrics(truth = truth, estimate = .pred)
#baseline corrected
abcd_brainage_baseline  %>%
  metrics(truth = truth, estimate = corrected_pred)



ggscatter(corrected_multiwave_brainage, x = "truth", y = ".pred",
   color = "#00AFBB", # Points color, shape and size
   add = "reg.line",  # Add regressin line
   add.params = list(color = "blue", fill = "lightgray"), # Customize reg. line
   conf.int = TRUE # Add confidence interval
   )


ggscatter(corrected_multiwave_brainage, x = "truth", y = "gap",
   color = "#00AFBB", # Points color, shape and size
   add = "reg.line",  # Add regressin line
   add.params = list(color = "blue", fill = "lightgray"), # Customize reg. line
   conf.int = TRUE # Add confidence interval
   )

ggscatter(corrected_multiwave_brainage, x = "truth", y = "corrected_pred",
   color = "#00AFBB", # Points color, shape and size
   add = "reg.line",  # Add regressin line
   add.params = list(color = "blue", fill = "lightgray"), # Customize reg. line
   conf.int = TRUE, # Add confidence interval
   xlab = "Scan/Chronological Age", ylab = "Predicted Age"
   )

ggscatter(corrected_multiwave_brainage, x = "truth", y = "corrected_gap",
   color = "#00AFBB", # Points color, shape and size
   add = "reg.line",  # Add regressin line
   add.params = list(color = "blue", fill = "lightgray"), # Customize reg. line
   conf.int = TRUE, # Add confidence interval
   xlab = "Scan/Chronological Age"
   )


```




