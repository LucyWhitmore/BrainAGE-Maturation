---
title: "ChangeScores"
author: "Lucy Whitmore"
date: "7/7/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

packages <-  c("tidyverse",
               "reshape2",
               "nlme", "lme4",
               "data.table", "psych",
               "parallel","lubridate",
               "ggpubr", "broom", 
               "apaTables", "MetBrewer")
if (length(setdiff(packages, rownames(installed.packages()))) > 0) {
  install.packages(setdiff(packages, rownames(installed.packages())))  
}
lapply(packages, library, character.only = TRUE)
```

Load Structural Data
```{r}
load("/Volumes/devbrainlab/Lucy/BrainAGE/fyp/renamed_smri_followup.Rda")
load("/Volumes/devbrainlab/Lucy/BrainAGE/fyp/renamed_smri_baseline.Rda")

smri_abcd_model_baseline <- renamed_smri_baseline[, 1:180] 
smri_abcd_model_followup <- renamed_smri_followup[, 1:180] 

```

Load data
```{r}
#Load smri_baseline

#Load smri_followup

smri_difference <- left_join(smri_abcd_model_baseline, smri_abcd_model_followup, by ="src_subject_id")
#could right join to reduce NAs 

```


for loop - doesn't work very well
```{r}
difference1 <- c(1, 2, 3, 4, 5)
difference2 <- c(2, 4, 6, 8, 10)
difference3 <- c(1, 3, 5, 7, 9)
difference4 <- c(1, 2, 3, 4, 5)
difference5 <- c(5, 4, 3, 2, 1)
difference6 <- c(1, 2, 3, 5, 8)

difference_df <- data.frame(difference1, difference2, difference3, difference4, difference5, difference6)
difference_df

for (i in 1:(ncol(difference_df)/2)){
  print(i)
  print(i + ncol(difference_df)/2)
  difference_df[ncol(difference_df)+1] <-  difference_df[i + ncol(difference_df)/2] - difference_df[i]
  #print(dif)
}
```

other version
```{r}
#make empty dataframe that only has ids/numbers
#loop through columns, subtract as usual
#rbind (or append, or join, or whatever) the new difference score column onto the new data frame
#end up with dataframe of only ids and difference scores
diff_df <- data.frame(c("id1", "id2", "id3", "id4", "id5"))

for (i in 1:(ncol(difference_df)/2)){
  #print(i)
  #print(i + ncol(difference_df)/2)
  print((difference_df[i + ncol(difference_df)/2] - difference_df[i]))
  cbind(diff_df, (difference_df[i + ncol(difference_df)/2] - difference_df[i]))  
  #print(dif)
}
diff_df
```

Calculate difference scores format
# Stack Exchange - this works!
```{r}

difference1.x <- c(1, 2, 3, 4, 5)
difference2.x <- c(2, 4, 6, 8, 10)
difference3.x <- c(1, 3, 5, 7, 9)
difference1.y <- c(1, 2, 3, 4, 5)
difference2.y <- c(5, 4, 3, 2, 1)
difference3.y <- c(1, 2, 3, 5, 8)

difference_df_xy <- data.frame(difference1.x, difference2.x, difference3.x, difference1.y, difference2.y, difference3.y)
difference_df_xy

# Stack Exchange - this works!
difference_df_xy %>%
 mutate(across(ends_with(".y"), .names = "{col}_diff") - across(ends_with(".x"))) %>%
 rename_with(~ sub("_\\d+", "", .), ends_with("_diff"))

#need to subtract, then divide by age gap
```

Calculate difference scores
```{r}
smri_difference_calculated <- smri_difference %>%
 select(-c(subjectkey.x,subjectkey.y, sex.x,sex.y, eventname.x,eventname.y)) %>% 
 mutate(across(ends_with(".y"), .names = "{col}_diff") - across(ends_with(".x"))) %>%
 rename_with(~ sub("_\\d+", "", .), ends_with("_diff"))

#need to subtract, then divide by age gap
```

Test to make sure this worked
```{r}
smri_difference_calculated$interview_age.y[1] - smri_difference_calculated$interview_age.x[1]
smri_difference_calculated$interview_age.y_diff[1]


smri_difference_calculated$FS_L_Fusiform_Area.y[1] - smri_difference_calculated$FS_L_Fusiform_Area.x[1]
smri_difference_calculated$FS_L_Fusiform_Area.y_diff[1]


#test with NA
smri_difference_calculated$interview_age.y[3] - smri_difference_calculated$interview_age.x[3]
smri_difference_calculated$interview_age.y_diff[3]

smri_difference_calculated$FS_L_Fusiform_Area.y[3] - smri_difference_calculated$FS_L_Fusiform_Area.x[3]
smri_difference_calculated$FS_L_Fusiform_Area.y_diff[3]


#stopifnot(smri_difference_calculated$FS_L_Fusiform_Area.y[3] - smri_difference_calculated$FS_L_Fusiform_Area.x[3] == smri_difference_calculated$FS_L_Fusiform_Area.y_diff[3])



```

Prep for training
```{r}
# Select only difference columns
smri_difference_calculated_subset <- smri_difference_calculated %>% 
  select(src_subject_id, ends_with("diff")) 


#divide all brain columns by change in interview age
smri_difference_calculated_subset[, -(1:2)] <- sweep(smri_difference_calculated_subset[, -(1:2)], 1, smri_difference_calculated_subset[, 2], "/")


# testing
#difference_df_scaled<- difference_df[,-(1:2)] %>% sapply(`/`, difference_df[,2]) 

#smri_difference_calculated_scaled<- smri_difference_calculated_subset[,-(1:2)] %>% sapply(`/`, smri_difference_calculated_subset[,2]) 
#try lapply instead

#difference_df_scaled<- difference_df %>%  
#  mutate(across(everything(), -c(difference1, difference2) ~ . / !! difference2))

#difference_df_scaled<- difference_df %>% 
 # mutate(across(!difference1 & !difference2), ~ . / !! difference2)

#difference_df_scaled<- difference_df %>% 
 # mutate(across(.cols = -c(difference1, difference2), . / difference2(., na.rm = FALSE)))

#difference_df_scaled<- difference_df %>%
#  mutate_at(vars(-difference1 -difference2),
  #          ~ . / !! difference2
#  )

#difference_df_scale <- difference_df
#difference_df_scale[, -(1:2)] <- sweep(difference_df_scale[, -(1:2)], 1, difference_df_scale[, 2], "/")

####

#smri_difference_calculated_scaled$src_subject_id <- smri_difference_calculated_subset$src_subject_id

#smri_difference_calculated_scaled$interview_age_diff <- smri_difference_calculated_subset$interview_age.y_diff


# Should we be predicting the change in age?

#probably filter out people w/o age_diff scores
smri_difference_calculated_filtered <- smri_difference_calculated_subset %>% 
  filter(!is.na(interview_age.y_diff))
  
#calculate midpoint age, use change scores to predict midpoint
smri_difference_calculated_filtered <- smri_difference_calculated_filtered %>% 
  left_join(smri_difference %>%  select(src_subject_id, interview_age.x, interview_age.y)) %>% 
  rowwise() %>% 
  mutate(age_midpoint = mean(c(interview_age.x, interview_age.y))) %>% 
  ungroup()

smri_difference_calculated_filtered <- smri_difference_calculated_filtered %>% 
  ungroup()

save(smri_difference_calculated_filtered, file="smri_difference_scores.Rda")

# select just subject_id, brain columns, age midpoint

#load("smri_difference_scores.Rda")




#1000 people for training

#Split sample
smp_size_diff <- floor(0.13 * nrow(smri_difference_calculated_filtered)) #training sample of 1000 participants 

## set the seed to make your partition reproducible
set.seed(123)
sample_ind_diff <- sample(seq_len(nrow(smri_difference_calculated_filtered)), size = smp_size_diff)

sample_train_diff <- smri_difference_calculated_filtered[sample_ind_diff, ]
sample_test_diff <- smri_difference_calculated_filtered[-sample_ind_diff, ]

# select just subject_id, brain columns, age midpoint
sample_train_diff <- sample_train_diff %>% 
select(-c(src_subject_id, interview_age.y_diff, interview_age.x, interview_age.y))


save(sample_train_diff, file="sample_train_diff.Rda")
save(sample_test_diff, file="sample_test_diff.Rda")



```



############################################################
MAY 2023 Update - New Approach
###########################################################

Updates to this version: Predicting T2 age from difference scores (scaled by time interval, in delta interview age)

Load Structural Data
```{r}
#Load list of included subjects
struc_include_baseline<-rio::import("/Volumes/devbrainlab/ABCD_Data/ABCD4pt0/abcd_imgincl01.txt") %>%
  filter(!collection_title=="collection_title") %>% 
  select(1:11) %>% 
  mutate(interview_age = as.numeric(interview_age),
        imgincl_t1w_include = as.numeric(imgincl_t1w_include)) %>% 
  filter(imgincl_t1w_include == 1) %>% 
  filter(eventname=="baseline_year_1_arm_1")
  
  
struc_include_followup<-rio::import("/Volumes/devbrainlab/ABCD_Data/ABCD4pt0/abcd_imgincl01.txt") %>%
  filter(!collection_title=="collection_title") %>% 
  select(1:11) %>% 
  mutate(interview_age = as.numeric(interview_age),
        imgincl_t1w_include = as.numeric(imgincl_t1w_include)) %>% 
  filter(imgincl_t1w_include == 1) %>% 
  filter(eventname=="2_year_follow_up_y_arm_1")


#Load structural data
#Filter for volume & area measurements
smri_baseline_v2 <- rio::import("/Volumes/devbrainlab/ABCD_Data/ABCD4pt0/abcd_smrip10201.txt") %>%
  filter(eventname=="baseline_year_1_arm_1") %>% 
  filter(!collection_title=="collection_title") %>% 
  filter(src_subject_id%in%struc_include_baseline$src_subject_id) %>% 
  select(subjectkey, src_subject_id, interview_age, sex, eventname, matches("vol|area|thick")) %>% 
  select(-contains(c('cf'))) %>% #remove genetically derived parcellations
  select(-c(smri_area_cdk_totallh, smri_area_cdk_totalrh, smri_area_cdk_total, smri_vol_scs_lesionlh, smri_vol_scs_lesionrh, smri_vol_scs_wmhint, smri_vol_scs_wmhintlh, smri_vol_scs_wmhintrh, smri_vol_scs_wholeb, smri_vol_scs_latventricles, smri_vol_scs_allventricles, smri_vol_scs_cbwmatterrh, smri_vol_scs_cbwmatterlh))



smri_followup_v2 <- rio::import("/Volumes/devbrainlab/ABCD_Data/ABCD4pt0/abcd_smrip10201.txt") %>%
  filter(eventname=="2_year_follow_up_y_arm_1") %>% 
  filter(!collection_title=="collection_title") %>% 
  filter(src_subject_id%in%struc_include_followup$src_subject_id) %>% 
  select(subjectkey, src_subject_id, interview_age, sex, eventname, matches("vol|area|thick")) %>% 
  select(-contains(c('cf'))) %>% #remove genetically derived parcellations
  select(-c(smri_area_cdk_totallh, smri_area_cdk_totalrh, smri_area_cdk_total, smri_vol_scs_lesionlh, smri_vol_scs_lesionrh, smri_vol_scs_wmhint, smri_vol_scs_wmhintlh, smri_vol_scs_wmhintrh, smri_vol_scs_wholeb, smri_vol_scs_latventricles, smri_vol_scs_allventricles, smri_vol_scs_cbwmatterrh, smri_vol_scs_cbwmatterlh))


#renamed_smri_baseline<-rio::import("/Volumes/devbrainlab/Lucy/BrainAGE/FYP/renamed_smri_baseline.Rda")

```

Load and join data
```{r}

#Convert to numeric
smri_baseline_v2[,6:ncol(smri_baseline_v2)] <- sapply(smri_baseline_v2[,6:ncol(smri_baseline_v2)],as.numeric)

# Calculate age in years
smri_baseline_v2 <- smri_baseline_v2 %>% 
  mutate(interview_age = as.numeric(interview_age)/12)

#Convert to numeric
smri_followup_v2[,6:ncol(smri_followup_v2)] <- sapply(smri_followup_v2[,6:ncol(smri_followup_v2)],as.numeric)

# calculate age in years
smri_followup_v2 <- smri_followup_v2 %>% 
  mutate(interview_age = as.numeric(interview_age)/12)


smri_difference_v2 <- left_join(smri_baseline_v2, smri_followup_v2, by ="src_subject_id")
```




Calculate difference scores
```{r}
smri_difference_calculated_v2 <- smri_difference_v2 %>%
 select(-c(subjectkey.x,subjectkey.y, sex.x,sex.y, eventname.x,eventname.y)) %>% 
 mutate(across(ends_with(".y"), .names = "{col}_diff") - across(ends_with(".x"))) %>%
 rename_with(~ sub("_\\d+", "", .), ends_with("_diff"))

#need to subtract, then divide by age gap
```



Set up data
```{r}
smri_difference_v2 <- smri_difference_calculated_v2 %>% 
  select(src_subject_id, interview_age.y, ends_with("diff")) 


#divide all brain columns by change in interview age
# this gets us per year change (not a %, but numeric change per year)
smri_difference_v2[, -(1:3)] <- sweep(smri_difference_v2[, -(1:3)], 1, smri_difference_v2[, 3], "/")


smri_difference_v2 <- smri_difference_v2 %>% 
  filter(!is.na(interview_age.y_diff))


#1000 people for training

#Split sample
smp_size_diff_v2 <- floor(0.25 * nrow(smri_difference_v2)) #training sample of 1000 participants 

## set the seed to make your partition reproducible
set.seed(123)
sample_ind_diff_v2 <- sample(seq_len(nrow(smri_difference_v2)), size = smp_size_diff_v2)

sample_train_diff_v2 <- smri_difference_v2[sample_ind_diff_v2, ]
sample_test_diff_v2 <- smri_difference_v2[-sample_ind_diff_v2, ]

# select just subject_id, brain columns, age midpoint
sample_train_diff_v2 <- sample_train_diff_v2 %>% 
select(-c(src_subject_id, interview_age.y_diff))


save(sample_train_diff_v2, file="sample_train_diff_v2.Rda")
save(sample_test_diff_v2, file="sample_test_diff_v2.Rda")
```




