---
title: "Revisions Analyses & Figures"
author: "Lucy Whitmore"
date: "7/26/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Install combat
```{r}
library(devtools)
install_github("jfortin1/neuroCombatData")
install_github("jfortin1/neuroCombat_Rpackage")


library(tidymodels) # machine learning metaverse
library(xgboost) # main engine, needs version 1.0.0.2, see above
library(effectsize)
library(psych)
library(ggpubr)
library(vip)
```

Load everything (corrected)
```{r}
load("~/Documents/FYP/Revisions/abcd_brainage_pds_baseline_combat.Rda")
load("~/Documents/FYP/Revisions/abcd_brainage_pds_followup_combat.Rda")

load("~/Documents/FYP/Revisions/brainage_pds_baseline_combat.Rda")
load("~/Documents/FYP/Revisions/brainage_pds_followup_combat.Rda")

```

Load everything (uncorrected for scanner)
```{r}
# BrainAGE and Behavioral Data - Vlad's Model, Baseline
load("/Volumes/devbrainlab/Lucy/BrainAGE/fyp/BrainagePDSBaseline.Rda")

# BrainAGE and Behavioral Data - Vlad's Model, Follow-Up
load("/Volumes/devbrainlab/Lucy/BrainAGE/fyp/BrainagePDSFollowUp.Rda")

# BrainAGE and Behavioral Data - ABCD Model, Baseline
load("/Volumes/devbrainlab/Lucy/BrainAGE/fyp/ABCDBaselineSample.Rda")
```

Load Structural Data
```{r}
#Load list of included subjects
struc_include_baseline<-rio::import("/Volumes/devbrainlab/ABCD_Data/ABCD4pt0/abcd_imgincl01.txt") %>%
  filter(!collection_title=="collection_title") %>% 
  select(1:11) %>% 
  mutate(interview_age = as.numeric(interview_age),
        imgincl_t1w_include = as.numeric(imgincl_t1w_include)) %>% 
  filter(imgincl_t1w_include == 1) %>% 
  filter(eventname=="baseline_year_1_arm_1")
  
  
struc_include_followup<-rio::import("/Volumes/devbrainlab/ABCD_Data/ABCD4pt0/abcd_imgincl01.txt") %>%
  filter(!collection_title=="collection_title") %>% 
  select(1:11) %>% 
  mutate(interview_age = as.numeric(interview_age),
        imgincl_t1w_include = as.numeric(imgincl_t1w_include)) %>% 
  filter(imgincl_t1w_include == 1) %>% 
  filter(eventname=="2_year_follow_up_y_arm_1")


#Load structural data
#Filter for volume & area measurements

##### Need to also select scanner/site #####
smri_baseline <- rio::import("/Volumes/devbrainlab/ABCD_Data/ABCD4pt0/abcd_smrip10201.txt") %>%
  filter(eventname=="baseline_year_1_arm_1") %>% 
  filter(!collection_title=="collection_title") %>% 
  filter(src_subject_id%in%struc_include_baseline$src_subject_id) %>% 
  select(subjectkey, src_subject_id, interview_age, sex, eventname, matches("vol|area")) %>% 
  select(-contains(c('cf'))) %>% #remove genetically derived parcellations
  select(-c(smri_area_cdk_totallh, smri_area_cdk_totalrh, smri_area_cdk_total, smri_vol_scs_lesionlh, smri_vol_scs_lesionrh, smri_vol_scs_wmhint, smri_vol_scs_wmhintlh, smri_vol_scs_wmhintrh, smri_vol_scs_wholeb, smri_vol_scs_latventricles, smri_vol_scs_allventricles, smri_vol_scs_cbwmatterrh, smri_vol_scs_cbwmatterlh))


smri_followup <- rio::import("/Volumes/devbrainlab/ABCD_Data/ABCD4pt0/abcd_smrip10201.txt") %>%
  filter(eventname=="2_year_follow_up_y_arm_1") %>% 
  filter(!collection_title=="collection_title") %>% 
  filter(src_subject_id %in% struc_include_followup$src_subject_id) %>% 
  select(subjectkey, src_subject_id, interview_age, sex, eventname, matches("vol|area")) %>% 
  select(-contains(c('cf'))) %>% #remove genetically derived parcellations
  select(-c(smri_area_cdk_totallh, smri_area_cdk_totalrh, smri_area_cdk_total, smri_vol_scs_lesionlh, smri_vol_scs_lesionrh, smri_vol_scs_wmhint, smri_vol_scs_wmhintlh, smri_vol_scs_wmhintrh, smri_vol_scs_wholeb, smri_vol_scs_latventricles, smri_vol_scs_allventricles, smri_vol_scs_cbwmatterrh, smri_vol_scs_cbwmatterlh))



```


# combat/site standardization
```{r}
# load raw data
# filter for quality data
# keep scanner site

#https://github.com/Jfortin1/neuroCombat_Rpackage/tree/2ccab2b42c59163717f012c70a54d20e8757b1c7
# can realign to virtual site or to reference site

data.harmonized <- neuroCombat(dat=dat, batch=batch) # batch is the site/scanner
# maybe need to add age (and gender?) as a covariate, mod = 

# maybe run without empirical bayes because number of features is smaller than number of participants?
#data.harmonized <- neuroCombat(dat=dat, batch=batch, eb=FALSE)


# Load data harmonized using LongCombat - longCombat.R
load("Volumes/devbrainlab/Lucy/BrainAGE/fyp/harmonized_mri_baseline.Rda")
load("Volumes/devbrainlab/Lucy/BrainAGE/fyp/harmonized_mri_followup.Rda")

```

Data Cleaning for harmonized data
```{r}
mod_1 <- readRDS(
  file = here::here(
    "DevelopmentalBrainAge/model/xgboost_9to19_brain_age_mod.rds")) 


# check for any columns that aren't in model
names.use <- names(model1_features_baseline)[!(names(model1_features_baseline) %in% mod_1$fit$feature_names)]

# baseline
# remove those columns
model1_features_baseline_clean <- model1_features_baseline %>% 
  select(-c(FS_R_Cerebellum_Cort_Vol, interview_age))

# reorder column names to match order of feature names
newdata_baseline = as.matrix(model1_features_baseline_clean)
newdata_baseline = newdata_baseline[ , mod_1$fit$feature_names]

### Follow-Up
# remove those columns
model1_features_followup_clean <- model1_features_followup %>% 
  select(-c(FS_R_Cerebellum_Cort_Vol, interview_age))

# reorder column names to match order of feature names
newdata_followup = as.matrix(model1_features_followup_clean)
newdata_followup = newdata_followup[ , mod_1$fit$feature_names]
```


# rerun predictions on harmonized data
```{r}
# drop scanner site variable from data

# predict brainage - baseline, model 1

# Predict
# This prediction method gives the output as a vector, we'll fix that later on
brainage_mod1_baseline <-
  mod_1$fit %>%
  predict(newdata = newdata_baseline) 

# Calculate gap
# Turn the vector into a dataframe, rename the prediction column, add back the column with chronological age, and calculate the gap
brain_age_df_mod1_baseline <- as.data.frame(brainage_mod1_baseline) %>%
  rename(.pred = brainage_mod1_baseline) %>% 
  mutate(
    # provide the chronological age at time of scan
    truth = model1_features_baseline$interview_age) %>%
  # compute the brain age gap by subtracting chronological age from prediction
  mutate(gap = .pred - truth)


# bias correction
# Slope and intercept are hardcoded
bias_intercept <- 6.41 # xgb_bias_mod$coefficients[["(Intercept)"]]
bias_slope <- 0.55 # xgb_bias_mod$coefficients[["truth"]]

# create bias corrected data frame
brain_age_df_mod1_baseline_corrected <- brain_age_df_mod1_baseline %>%
  mutate(
    # corrected brain age prediction
    corrected_pred =  (.pred - bias_intercept) / bias_slope
  ) %>%
  # corrected corrected brain age gap
  mutate(corrected_gap = corrected_pred - truth)

# reattach IDs
brain_age_df_mod1_baseline_corrected$src_subject_id <- harmonized_mri_baseline$src_subject_id



# predict brainage - followup, model 1
brainage_mod1_followup <-
  mod_1$fit %>%
  predict(newdata = newdata_followup) 

# Calculate gap
# Turn the vector into a dataframe, rename the prediction column, add back the column with chronological age, and calculate the gap
brain_age_df_mod1_followup <- as.data.frame(brainage_mod1_followup) %>%
  rename(.pred = brainage_mod1_followup) %>% 
  mutate(
    # provide the chronological age at time of scan
    truth = model1_features_followup$interview_age) %>%
  # compute the brain age gap by subtracting chronological age from prediction
  mutate(gap = .pred - truth)


# create bias corrected data frame
brain_age_df_mod1_followup_corrected <- brain_age_df_mod1_followup %>%
  mutate(
    # corrected brain age prediction
    corrected_pred =  (.pred - bias_intercept) / bias_slope
  ) %>%
  # corrected corrected brain age gap
  mutate(corrected_gap = corrected_pred - truth)

# reattach IDs
brain_age_df_mod1_followup_corrected$src_subject_id <- harmonized_mri_followup$src_subject_id


# predict brainage - baseline, model 2
#brainage <-
 # fit_workflow %>%
#  predict(new_data = analysis_sample_baseline) %>%
#  mutate(
    # provide the chronological age at time of scan
#    truth = analysis_sample_baseline$interview_age
 # ) %>%
  # compute the brain age gap by subtracting chronological age from prediction
#  mutate(gap = .pred - truth)


# predict brainage - follow-up, model 2 (3?)

#followup_brainage <-
#  fit_workflow_followup %>%
#  predict(new_data = analysis_sample_baseline) %>%
#  mutate(
    # provide the chronological age at time of scan
#    truth = analysis_sample_baseline$interview_age
 # ) %>%
  # compute the brain age gap by subtracting chronological age from prediction
 # mutate(gap = .pred - truth)
```



# fit metrics
```{r}
abcd_brainage_pds_followup_combat %>%
  metrics(truth = truth, estimate = .pred)

abcd_brainage_pds_followup_combat %>%
  metrics(truth = truth, estimate = corrected_pred)


cor(abcd_brainage_pds_followup_combat$truth, abcd_brainage_pds_followup_combat$corrected_gap)
```


# model features and importance
```{r}
# vip plot of feature importance
library(vip)

## testing
load("~/Documents/FYP/UpdatedModels/fit_workflow_combat.rds")
#model_obj <- xgb.load("~/Documents/FYP/UpdatedModels/abcd_model_obj_combat")
#model_obj_indexed <- fit_workflow_combat$fit$fit$fit

vi(fit_workflow_combat)


colnames(df_train)[!(colnames(df_train) %in% vi(fit_workflow_combat)$Variable)]

#xgb.importance(extract_fit_parsnip(fit_workflow_combat))
#xgb.importance(model = model_obj)
#xgb.importance(model = model_obj_indexed)

#xgb.plot.importance(xgb.importance(model = model_obj))

vip(fit_workflow_combat, num_features=20) +
  theme_light()
ggsave(filename="model2_vip_baseline.png",
                          width=7, height=4, units='in', dpi=300)



load("~/Documents/FYP/Revisions/fit_workflow_combat_followup.rds")
#model_obj_followup <- xgb.load("~/Documents/FYP/Revisions/abcd_model_obj_combat_followup")
#model_obj_indexed_followup <- fit_workflow_combat_followup$fit$fit$fit

vi(fit_workflow_combat_followup)

vip(fit_workflow_combat_followup, num_features=20) +
  theme_light()
ggsave(filename="model2_vip_followup.png",
                          width=7, height=4, units='in', dpi=300)
## from model code

final_xgb_combat %>%
  fit(data = df_train) %>%
  extract_fit_parsnip() %>%
  vip(geom = "point")

fit_workflow_combat %>%
  fit(data = df_train) %>%
  extract_fit_parsnip() %>%
  vi()

###

#vip(abcd_model_obj_combat, num_features = 175) 
#vip(abcd_model_obj_combat, num_features = 20) 
#vi_updated <- vi(abcd_model_obj_combat)
#vi(fit_workflow_combat)
#vi(fit_workflow_combat, method = "shap")

vi(fit_workflow_combat)


#vi(fit_workflow_combat$fit$fit)
#vi(fit_workflow_combat$fit$fit$fit)


vi_updated <- vi(extract_fit_parsnip(fit_workflow_combat)) # this seems to work!

vip(extract_fit_parsnip(fit_workflow_combat), num_features = 20)


```

ggseg importance plots
```{r}
# ggseg importance plots
# Rename columns to fit with ggseg atlas


# select only name and atlas name, then join with new vip estimates to get around renaming by hand
abcd_vi_renamed <- rio::import("~/Documents/FYP/abcd_vi_renamed.csv") %>% 
  select(Variable, brain_labels_dk, label)

#abcd_vi <- left_join(vi(abcd_model_obj_combat), abcd_vi_renamed)
abcd_vi <- left_join(vi_updated, abcd_vi_renamed)

abcd_vi_renamed_dk <- rio::import("~/Documents/FYP/abcd_vi_renamed_dk.csv") %>% 
  select(Variable, label, aseg_label)

abcd_vi_dk <- left_join(vi(abcd_model_obj_combat), abcd_vi_renamed_dk)


#check labels
brain_labels(dk)
brain_labels(aseg)


#Cortical - Volume
dk_vi_vol <- abcd_vi_dk %>%
  filter(grepl('Vol', Variable)) %>% 
  filter(label != "") %>% 
  select(Importance,label)

dk_vi_vol <- data.frame(dk_vi_vol)

ggplot(dk_vi_vol) +
  geom_brain(atlas = dk, position = position_brain(hemi ~ side), aes(fill = Importance))+
  theme_void() +
  scale_fill_gradient(low = '#FDD872', high = '#E76F51') +
  labs(title = "Cortical Volume")
ggsave(filename="abcd_model_dk_vol_importance_combat.png",
                         width=8, height=4, units='in', dpi=300)


#Cortical - Area
dk_vi_area <- abcd_vi_dk %>%
  filter(grepl('Area', Variable)) %>% 
  filter(label != "") %>% 
  select(Importance,label)

dk_vi_area <- data.frame(dk_vi_area)

ggplot(dk_vi_area) +
  geom_brain(atlas = dk, position = position_brain(hemi ~ side), aes(fill = Importance))+
  theme_void() +
  scale_fill_gradient(low = '#FDD872', high = '#E76F51') +
  labs(title = "Cortical Area")
ggsave(filename="abcd_model_dk_area_importance_combat.png",
                         width=8, height=4, units='in', dpi=300)




#Subcortical
aseg_vi <- abcd_vi %>%
  filter(label != "") %>% 
  select(Importance,label)

aseg_vi <- data.frame(aseg_vi)

  
ggplot(aseg_vi) +
  geom_brain(atlas = aseg, side="coronal", aes(fill = Importance))+
  theme_void() +
  scale_fill_gradient(low = '#FDD872', high = '#E76F51')
ggsave(filename="abcd_model_aseg_importance_coronal_combat.png",
                          width=7, height=4, units='in', dpi=300)


ggplot(aseg_vi) +
  geom_brain(atlas = aseg, side="sagittal", aes(fill = Importance))+
  theme_void() +
  scale_fill_gradient(low = '#FDD872', high = '#E76F51')
ggsave(filename="abcd_model_aseg_importance_sagittal_combat.png",
                          width=7, height=4, units='in', dpi=300)


#troubleshooting names
aseg_labs <- brain_labels(aseg) |> 
  as.character()
aseg_vi$label[!aseg_vi$label %in% aseg_labs]
aseg_labs[!aseg_labs %in% aseg_vi$label]



dk_labs <- brain_labels(dk) |> 
  as.character()
dk_vi_area$label[!dk_vi_area$label %in% dk_labs]
dk_vi_vol$label[!dk_vi_vol$label %in% dk_labs]


dk_labs[!dk_labs %in% dk_vi_area$label]
dk_labs[!dk_labs %in% dk_vi_vol$label]

```

# attach pds and cognition measures to BrainAGE estimates
```{r}
youth_pds <- rio::import("/Volumes/devbrainlab/ABCD_Data/ABCD4pt0/abcd_ypdms01.txt") %>%
  filter(!collection_title=="collection_title") %>% 
  select(5:38) %>% 
  select(-c(interview_date, pds_remote___1, pds_remote___2, pds_remote___3, pds_remote___4, pds_device)) %>% 
  mutate_at(c(5:28), as.numeric)

#Raw scores, parent
parent_pds <- rio::import("/Volumes/devbrainlab/ABCD_Data/ABCD4pt0/abcd_ppdms01.txt") %>%
  filter(!collection_title=="collection_title")  %>% 
  select(5:27) %>% 
  select(-c(interview_date, pds_select_language___1)) %>% 
  mutate_at(c(5:21), as.numeric)

#Cognition Scores (Age-Corrected)
cognition <- rio::import("/Volumes/devbrainlab/ABCD_Data/ABCD4pt0/abcd_tbss01.txt") %>%
  filter(!collection_title=="collection_title")  %>% 
  select(src_subject_id,interview_age, eventname, nihtbx_fluidcomp_agecorrected, nihtbx_cryst_agecorrected, nihtbx_totalcomp_agecorrected, nihtbx_totalcomp_uncorrected) %>% 
  mutate_at(c(2, 4:7), as.numeric)



#two or more missing values = exclude
#PDS mean score is a continuous value calculated by averaging across PDS items following Herting et al. (2021). Items on the PDS were considered missing if participants answered, “I don’t know” or “refuse to answer”, if the response was left blank, or if the response value was outside of the expected range (1 to 4). Participants with two or more missing answers were excluded from the PDS score calculation (following recommendations from (Herting et al., 2021)


### Youth-report, removes everyone w/o complete data
youth_pds[youth_pds == 777] <- NA
youth_pds[youth_pds == 999] <- NA


# Multiwave
youth_pds_multiwave <- youth_pds %>% 
  filter(eventname == "baseline_year_1_arm_1" | eventname == "2_year_follow_up_y_arm_1") %>% 
  mutate(youth_sum = case_when(sex == "M" ~ #male
                           (pds_ht2_y + pds_bdyhair_y + pds_skin2_y + pds_m4_y + pds_m5_y),  
                         sex == "F" ~ #female
                           (pds_ht2_y + pds_bdyhair_y + pds_skin2_y + pds_f4_2_y + pds_f5_y))) %>% 
  mutate(youth_mean = youth_sum/5)  %>% 
  select(src_subject_id, eventname, sex, youth_sum, youth_mean)

youth_pds_baseline <- youth_pds_multiwave %>% 
  filter(eventname == "baseline_year_1_arm_1") %>% 
  select(-eventname)
  
youth_pds_followup <- youth_pds_multiwave %>% 
  filter(eventname == "2_year_follow_up_y_arm_1") %>% 
  select(-eventname)
  


#### Parent-report, removes everyone w/o complete data
parent_pds[parent_pds == 777] <- NA
parent_pds[parent_pds == 999] <- NA

#Baseline
parent_pds_multiwave <- parent_pds %>% 
    filter(eventname == "baseline_year_1_arm_1" | eventname == "2_year_follow_up_y_arm_1") %>% 
    mutate(parent_sum = case_when(sex == "M" ~ #male
                           (pds_1_p + pds_2_p + pds_3_p + pds_m4_p + pds_m5_p),  
                         sex == "F" ~ #female
                           (pds_1_p + pds_2_p + pds_3_p + pds_f4_p + pds_f5b_p))) %>% 
  mutate(parent_mean = parent_sum/5) %>% 
  select(src_subject_id, eventname, sex, parent_sum, parent_mean)


parent_pds_baseline <- parent_pds_multiwave %>% 
    filter(eventname == "baseline_year_1_arm_1") %>% 
  select(-eventname)


parent_pds_followup <- parent_pds_multiwave%>% 
    filter(eventname == "2_year_follow_up_y_arm_1")%>% 
  select(-eventname)


#### Cognition

#Baseline
cognition_baseline <- cognition %>% 
  filter(eventname == "baseline_year_1_arm_1") %>% 
  select(-eventname) %>%
  mutate(cog_zscore = scale(nihtbx_totalcomp_uncorrected))



#### Create Dataframes for Analysis #####
# join brainage, pds, cognition - change names
brainage_pds_baseline_combat <- brain_age_df_mod1_baseline_corrected[, c(6,1:5)] %>% 
  left_join(youth_pds_baseline) %>% 
  left_join(parent_pds_baseline) %>% 
  left_join(cognition_baseline)

brainage_pds_followup_combat <- brain_age_df_mod1_followup_corrected[, c(6,1:5)] %>% 
  left_join(youth_pds_followup) %>% 
  left_join(parent_pds_followup)

save(brainage_pds_baseline_combat, file="brainage_pds_baseline_combat.Rda")
save(brainage_pds_followup_combat, file="brainage_pds_followup_combat.Rda")


# abcd model, baseline
abcd_brainage_pds_baseline_combat <- brain_age_corrected_df_combat %>% 
    left_join(youth_pds_baseline) %>% 
    left_join(parent_pds_baseline) %>% 
    left_join(cognition_baseline)

save(abcd_brainage_pds_baseline_combat, file="abcd_brainage_pds_baseline_combat.Rda")

# abcd model, follow-up
abcd_brainage_pds_followup_combat <- brain_age_corrected_df_combat_followup %>% 
    left_join(youth_pds_followup) %>% 
    left_join(parent_pds_followup)

save(abcd_brainage_pds_followup_combat, file="abcd_brainage_pds_followup_combat.Rda")



```


# rerun analyses without splitting
```{r}
## Baseline - Model 1
# get age in months
# mutate(interview_age_m = interview_age/12)

# brainage ~ youth mean
baseline_puberty_y_mod1 <- lm(corrected_gap ~ youth_mean + truth, data = brainage_pds_baseline_combat)

# brainage ~ parent mean
baseline_puberty_p_mod1 <- lm(corrected_gap ~ parent_mean + truth, data = brainage_pds_baseline_combat)

#standard scores - check that this is actually the one we're trying to use
baseline_cognition_mod1 <- lm(corrected_gap ~ nihtbx_totalcomp_uncorrected + truth, data=brainage_pds_baseline_combat)



## Followup - Model 1
# mutate(interview_age_m = interview_age/12)
# brainage ~ youth mean
followup_puberty_y_mod1 <- lm(corrected_gap ~ youth_mean + truth, data = brainage_pds_followup_combat)

# brainage ~ parent mean
followup_puberty_p_mod1 <- lm(corrected_gap ~ parent_mean + truth, data = brainage_pds_followup_combat)


## Baseline - Model 2
# mutate(interview_age_m = interview_age/12)
# brainage ~ youth mean
baseline_puberty_y_mod2 <- lm(corrected_gap ~ youth_mean + truth, data = abcd_brainage_pds_baseline_combat)

# brainage ~ parent mean
baseline_puberty_p_mod2 <- lm(corrected_gap ~ parent_mean + truth, data = abcd_brainage_pds_baseline_combat)

#standard scores - check that this is actually the one we're trying to use
baseline_cognition_mod2 <- lm(corrected_gap ~ nihtbx_totalcomp_uncorrected + truth, data=abcd_brainage_pds_baseline_combat)

## Followup - Model 2
# mutate(interview_age_m = interview_age/12)
# brainage ~ youth mean
followup_puberty_y_mod2 <- lm(corrected_gap ~ youth_mean + truth, data = abcd_brainage_pds_followup_combat)

# brainage ~ parent mean
followup_puberty_p_mod2 <- lm(corrected_gap ~ parent_mean + truth, data = abcd_brainage_pds_followup_combat)

```

# model summaries
```{r}
summary(baseline_puberty_y_mod1)
summary(baseline_puberty_p_mod1)
summary(baseline_cognition_mod1)


summary(followup_puberty_y_mod1)
summary(followup_puberty_p_mod1)


summary(baseline_puberty_y_mod2)
summary(baseline_puberty_p_mod2)
summary(baseline_cognition_mod2)

summary(followup_puberty_y_mod2)
summary(followup_puberty_p_mod2)

```

# Table of results
```{r}

apa.reg.table(baseline_puberty_y_mod1, filename= "apa_baseline_puberty_y_mod1.doc", table.number = 3)
apa.reg.table(baseline_puberty_p_mod1, filename= "apa_baseline_puberty_p_mod1.doc", table.number = 4)
apa.reg.table(baseline_cognition_mod1, filename= "apa_baseline_cognition_mod1.doc", table.number = 5)


apa.reg.table(followup_puberty_y_mod1, filename= "apa_followup_puberty_y_mod1.doc", table.number = 6)
apa.reg.table(followup_puberty_p_mod1, filename= "apa_followup_puberty_p_mod1.doc", table.number = 7)


apa.reg.table(baseline_puberty_y_mod2, filename= "apa_baseline_puberty_y_mod2.doc", table.number = 8)
apa.reg.table(baseline_puberty_p_mod2, filename= "apa_baseline_puberty_p_mod2.doc", table.number = 9)
apa.reg.table(baseline_cognition_mod2, filename= "apa_baseline_cognition_mod2.doc", table.number = 10)

apa.reg.table(followup_puberty_y_mod2, filename= "apa_followup_puberty_y_mod2.doc", table.number = 11)
apa.reg.table(followup_puberty_p_mod2, filename= "apa_followup_puberty_p_mod2.doc", table.number = 12)


apa.reg.table(baseline_puberty_y_mod1,baseline_puberty_p_mod1, baseline_cognition_mod1,  filename= "apa_baseline_mod1.doc", table.number = 3)

```

# standardize effect sizes
```{r}
library(effectsize)
# standardize(model) # updated model, refit with standardized data
# standardize_parameters(models) # table of standardized coefficients from model

# Baseline - Model 1
standardize_parameters(baseline_puberty_y_mod1)
standardize_parameters(baseline_puberty_p_mod1)
standardize_parameters(baseline_cognition_mod1)

# Follow-up - Model 1
standardize_parameters(followup_puberty_y_mod1)
standardize_parameters(followup_puberty_p_mod1)


# Baseline - Model 2
standardize_parameters(baseline_puberty_y_mod2)
standardize_parameters(baseline_puberty_p_mod2)
standardize_parameters(baseline_cognition_mod2)

# Followup - Model 2
standardize_parameters(followup_puberty_y_mod2)
standardize_parameters(followup_puberty_p_mod2)
standardize(followup_puberty_p_mod2)

```

# alternate standardization
```{r}
install.packages("lm.beta")
library(lm.beta)

summary(lm.beta(followup_puberty_y_mod2))


apa.reg.table(lm.beta(followup_puberty_y_mod2))

apa.reg.table(followup_puberty_y_mod2, filename= "apa_followup_puberty_y_mod2.doc", table.number = 1)
```

# Descriptive Table
```{r}
describe(brainage_pds_baseline_combat)

describe(brainage_pds_followup_combat)

describe(abcd_brainage_pds_baseline_combat)

describe(abcd_brainage_pds_followup_combat)
```

# recalculate demographics table
```{r}
demographics_baseline <- left_join(brainage_pds_baseline_combat, demographics)

demographics_followup <- left_join(brainage_pds_followup_combat, demographics)

demographics_baseline_abcdmodel <- left_join(abcd_brainage_pds_baseline_combat, demographics)

demographics_long <- rio::import("/Volumes/devbrainlab/ABCD_Data/ABCD4pt0/abcd_lpds01.txt") %>%
  filter(!collection_title=="collection_title") %>% 
  select(src_subject_id, eventname, demo_comb_income_v2_l)

demographics_baseline <- left_join(demographics_baseline, demographics_long %>% filter(eventname == "baseline_year_1_arm_1"))

demographics_followup <- left_join(demographics_followup, demographics_long %>% filter(eventname == "2_year_follow_up_y_arm_1"))

demographics_baseline_abcdmodel <- left_join(demographics_baseline_abcdmodel, demographics_long %>% filter(eventname == "baseline_year_1_arm_1"))




demographics_baseline_abcdmodel %>% 
  filter(demo_race_a_p___10 != 1 & demo_race_a_p___11 != 1 & demo_race_a_p___12 != 1 & demo_race_a_p___13 != 1 & (demo_race_a_p___14 == 1 | demo_race_a_p___15 == 1 | demo_race_a_p___16 == 1 | demo_race_a_p___17 == 1 | demo_race_a_p___25 == 1) & demo_race_a_p___18 != 1 & demo_race_a_p___19 != 1 & demo_race_a_p___20 != 1 & demo_race_a_p___21 != 1 & demo_race_a_p___22 != 1 & demo_race_a_p___23 != 1 & demo_race_a_p___24 != 1)
```
# Baseline (model 2)
```{r}
#Overall values
#Non-hispanic white
demographics_baseline_abcdmodel %>% 
  filter(demo_race_a_p___10 == 1 & demo_race_a_p___11 != 1 & demo_race_a_p___12 != 1 & demo_race_a_p___13 != 1 & demo_race_a_p___14 != 1 & demo_race_a_p___15 != 1 & demo_race_a_p___16 != 1 & demo_race_a_p___17 != 1 & demo_race_a_p___18 != 1 & demo_race_a_p___19 != 1 & demo_race_a_p___20 != 1 & demo_race_a_p___21 != 1 & demo_race_a_p___22 != 1 & demo_race_a_p___23 != 1 & demo_race_a_p___24 != 1 & demo_race_a_p___25 != 1 & demo_ethn_v2 != 1)

#Non-hispanic Black
demographics_baseline_abcdmodel %>% 
  filter(demo_race_a_p___10 != 1 & demo_race_a_p___11 == 1 & demo_race_a_p___12 != 1 & demo_race_a_p___13 != 1 & demo_race_a_p___14 != 1 & demo_race_a_p___15 != 1 & demo_race_a_p___16 != 1 & demo_race_a_p___17 != 1 & demo_race_a_p___18 != 1 & demo_race_a_p___19 != 1 & demo_race_a_p___20 != 1 & demo_race_a_p___21 != 1 & demo_race_a_p___22 != 1 & demo_race_a_p___23 != 1 & demo_race_a_p___24 != 1 & demo_race_a_p___25 != 1 & demo_ethn_v2 != 1)

#Hispanic
demographics_baseline_abcdmodel %>% 
  filter(demo_ethn_v2 == 1)

demographics_baseline_abcdmodel %>% 
  filter(((demo_race_a_p___10 == 1 | demo_race_a_p___11 == 1) & demo_race_a_p___12 != 1 & demo_race_a_p___13 != 1 & demo_race_a_p___14 != 1 & demo_race_a_p___15 != 1 & demo_race_a_p___16 != 1 & demo_race_a_p___17 != 1 & demo_race_a_p___18 != 1 & demo_race_a_p___19 != 1 & demo_race_a_p___20 != 1 & demo_race_a_p___21 != 1 & demo_race_a_p___22 != 1 & demo_race_a_p___23 != 1 & demo_race_a_p___24 != 1 & demo_race_a_p___25 != 1) & demo_ethn_v2 == 1)


#Asian
demographics_baseline_abcdmodel %>% 
  filter(demo_race_a_p___10 != 1 & demo_race_a_p___11 != 1 & demo_race_a_p___12 != 1 & demo_race_a_p___13 != 1 & demo_race_a_p___14 != 1 & demo_race_a_p___15 != 1 & demo_race_a_p___16 != 1 & demo_race_a_p___17 != 1 & ( demo_race_a_p___18 == 1 | demo_race_a_p___19 == 1 | demo_race_a_p___20 == 1 | demo_race_a_p___21 == 1 | demo_race_a_p___22 == 1 | demo_race_a_p___23 == 1 | demo_race_a_p___24 == 1) & demo_race_a_p___25 != 1 & demo_ethn_v2 != 1)

#Native American Alaska Native
demographics_baseline_abcdmodel %>% 
  filter(demo_race_a_p___10 != 1 & demo_race_a_p___11 != 1 & (demo_race_a_p___12 ==1 | demo_race_a_p___13 == 1) & demo_race_a_p___14 != 1 & demo_race_a_p___15 != 1 & demo_race_a_p___16 != 1 & demo_race_a_p___17 != 1 & demo_race_a_p___18 != 1 & demo_race_a_p___19 != 1 & demo_race_a_p___20 != 1 & demo_race_a_p___21 != 1 & demo_race_a_p___22 != 1 & demo_race_a_p___23 != 1 & demo_race_a_p___24 != 1 & demo_race_a_p___25 != 1 )


#Multiracial

# mutate column: true if participant marked any asian category
# mutate column: true if participant marked native american/alaska native
# sum white, black, asian, native american/alaska native, and additional races

demographics_baseline_abcdmodel %>% 
  mutate_at(c(12:33), as.numeric) %>% 
  mutate(
    demo_race_asian = case_when((demo_race_a_p___18 == 1 | demo_race_a_p___19 == 1 | demo_race_a_p___20 == 1 | demo_race_a_p___21 == 1 | demo_race_a_p___22 == 1 | demo_race_a_p___23 == 1 | demo_race_a_p___24 == 1) ~ 1,
                            (demo_race_a_p___18 != 1 & demo_race_a_p___19 != 1 & demo_race_a_p___20 != 1 & demo_race_a_p___21 != 1 & demo_race_a_p___22 != 1 & demo_race_a_p___23 != 1 & demo_race_a_p___24 != 1) ~ 0),
         demo_race_native_american_alaskan = case_when((demo_race_a_p___12 ==1 | demo_race_a_p___13 == 1) ~ 1,
                                                       (demo_race_a_p___12 !=1 & demo_race_a_p___13 != 1) ~ 0),
         race_total = rowSums(across(c(demo_race_a_p___10, demo_race_a_p___11, demo_race_a_p___14, demo_race_a_p___15, demo_race_a_p___16, demo_race_a_p___17, demo_race_a_p___25, demo_race_asian, demo_race_native_american_alaskan)), na.rm=T)) %>% 
  filter(race_total > 1)


#additional races
#If the caregiver chose Native Hawaiian, Guamanian, or Samoan, Other Race, or refused to choose a racial category, the youth was placed in the “additional” race group as there were too few youth in each of these categories individually for separate analysis.

demographics_baseline_abcdmodel %>% 
  filter(demo_race_a_p___10 != 1 & demo_race_a_p___11 != 1 & demo_race_a_p___12 != 1 & demo_race_a_p___13 != 1 & (demo_race_a_p___14 == 1 | demo_race_a_p___15 == 1 | demo_race_a_p___16 == 1 | demo_race_a_p___17 == 1 | demo_race_a_p___25 == 1) & demo_race_a_p___18 != 1 & demo_race_a_p___19 != 1 & demo_race_a_p___20 != 1 & demo_race_a_p___21 != 1 & demo_race_a_p___22 != 1 & demo_race_a_p___23 != 1 & demo_race_a_p___24 != 1)


demographics_followup_abcdmodel %>% 
  filter(demo_race_a_p___10 != 1 & demo_race_a_p___11 != 1 & demo_race_a_p___12 != 1 & demo_race_a_p___13 != 1 & (demo_race_a_p___14 == 1 | demo_race_a_p___15 == 1 | demo_race_a_p___16 == 1 | demo_race_a_p___17 == 1 | demo_race_a_p___25 == 1) & demo_race_a_p___18 != 1 & demo_race_a_p___19 != 1 & demo_race_a_p___20 != 1 & demo_race_a_p___21 != 1 & demo_race_a_p___22 != 1 & demo_race_a_p___23 != 1 & demo_race_a_p___24 != 1)


demographics_baseline %>% 
  filter(demo_race_a_p___10 != 1 & demo_race_a_p___11 != 1 & demo_race_a_p___12 != 1 & demo_race_a_p___13 != 1 & (demo_race_a_p___14 == 1 | demo_race_a_p___15 == 1 | demo_race_a_p___16 == 1 | demo_race_a_p___17 == 1 | demo_race_a_p___25 == 1) & demo_race_a_p___18 != 1 & demo_race_a_p___19 != 1 & demo_race_a_p___20 != 1 & demo_race_a_p___21 != 1 & demo_race_a_p___22 != 1 & demo_race_a_p___23 != 1 & demo_race_a_p___24 != 1)


demographics_followup %>% 
  filter(demo_race_a_p___10 != 1 & demo_race_a_p___11 != 1 & demo_race_a_p___12 != 1 & demo_race_a_p___13 != 1 & (demo_race_a_p___14 == 1 | demo_race_a_p___15 == 1 | demo_race_a_p___16 == 1 | demo_race_a_p___17 == 1 | demo_race_a_p___25 == 1) & demo_race_a_p___18 != 1 & demo_race_a_p___19 != 1 & demo_race_a_p___20 != 1 & demo_race_a_p___21 != 1 & demo_race_a_p___22 != 1 & demo_race_a_p___23 != 1 & demo_race_a_p___24 != 1)
```

# New Demographics Column for Follow- Up (Model 2)
```{r}
nrow(abcd_brainage_pds_followup_combat %>% filter(sex == "F")) / nrow(abcd_brainage_pds_followup_combat)
nrow(abcd_brainage_pds_followup_combat %>% filter(sex == "M")) / nrow(abcd_brainage_pds_followup_combat)

demographics <- rio::import("/Volumes/devbrainlab/ABCD_Data/ABCD4pt0/pdem02.txt") %>%
  filter(!collection_title=="collection_title") %>% 
  select(src_subject_id, contains("demo_race"), demo_ethn_v2, demo_ethn2_v2, demo_comb_income_v2)

demographics_followup_abcdmodel <- left_join(abcd_brainage_pds_followup_combat, demographics)

demographics_long <- rio::import("/Volumes/devbrainlab/ABCD_Data/ABCD4pt0/abcd_lpds01.txt") %>%
  filter(!collection_title=="collection_title") %>% 
  select(src_subject_id, eventname, demo_comb_income_v2_l)

demographics_followup_abcdmodel <- left_join(demographics_followup_abcdmodel, demographics_long %>% filter(eventname == "2_year_follow_up_y_arm_1"))


#family income
table(demographics_followup_abcdmodel$demo_comb_income_v2)
# /3693 for %

#Overall values
#Non-hispanic white
demographics_followup_abcdmodel %>% 
  filter(demo_race_a_p___10 == 1 & demo_race_a_p___11 != 1 & demo_race_a_p___12 != 1 & demo_race_a_p___13 != 1 & demo_race_a_p___14 != 1 & demo_race_a_p___15 != 1 & demo_race_a_p___16 != 1 & demo_race_a_p___17 != 1 & demo_race_a_p___18 != 1 & demo_race_a_p___19 != 1 & demo_race_a_p___20 != 1 & demo_race_a_p___21 != 1 & demo_race_a_p___22 != 1 & demo_race_a_p___23 != 1 & demo_race_a_p___24 != 1 & demo_race_a_p___25 != 1 & demo_ethn_v2 != 1)

#Non-hispanic Black
demographics_followup_abcdmodel %>% 
  filter(demo_race_a_p___10 != 1 & demo_race_a_p___11 == 1 & demo_race_a_p___12 != 1 & demo_race_a_p___13 != 1 & demo_race_a_p___14 != 1 & demo_race_a_p___15 != 1 & demo_race_a_p___16 != 1 & demo_race_a_p___17 != 1 & demo_race_a_p___18 != 1 & demo_race_a_p___19 != 1 & demo_race_a_p___20 != 1 & demo_race_a_p___21 != 1 & demo_race_a_p___22 != 1 & demo_race_a_p___23 != 1 & demo_race_a_p___24 != 1 & demo_race_a_p___25 != 1 & demo_ethn_v2 != 1)

#Hispanic
demographics_followup_abcdmodel %>% 
  filter(demo_ethn_v2 == 1)

demographics_followup_abcdmodel %>% 
  filter(((demo_race_a_p___10 == 1 | demo_race_a_p___11 == 1) & demo_race_a_p___12 != 1 & demo_race_a_p___13 != 1 & demo_race_a_p___14 != 1 & demo_race_a_p___15 != 1 & demo_race_a_p___16 != 1 & demo_race_a_p___17 != 1 & demo_race_a_p___18 != 1 & demo_race_a_p___19 != 1 & demo_race_a_p___20 != 1 & demo_race_a_p___21 != 1 & demo_race_a_p___22 != 1 & demo_race_a_p___23 != 1 & demo_race_a_p___24 != 1 & demo_race_a_p___25 != 1) & demo_ethn_v2 == 1)


#Asian
demographics_followup_abcdmodel %>% 
  filter(demo_race_a_p___10 != 1 & demo_race_a_p___11 != 1 & demo_race_a_p___12 != 1 & demo_race_a_p___13 != 1 & demo_race_a_p___14 != 1 & demo_race_a_p___15 != 1 & demo_race_a_p___16 != 1 & demo_race_a_p___17 != 1 & ( demo_race_a_p___18 == 1 | demo_race_a_p___19 == 1 | demo_race_a_p___20 == 1 | demo_race_a_p___21 == 1 | demo_race_a_p___22 == 1 | demo_race_a_p___23 == 1 | demo_race_a_p___24 == 1) & demo_race_a_p___25 != 1 & demo_ethn_v2 != 1)

#Native American Alaska Native
demographics_followup_abcdmodel %>% 
  filter(demo_race_a_p___10 != 1 & demo_race_a_p___11 != 1 & (demo_race_a_p___12 ==1 | demo_race_a_p___13 == 1) & demo_race_a_p___14 != 1 & demo_race_a_p___15 != 1 & demo_race_a_p___16 != 1 & demo_race_a_p___17 != 1 & demo_race_a_p___18 != 1 & demo_race_a_p___19 != 1 & demo_race_a_p___20 != 1 & demo_race_a_p___21 != 1 & demo_race_a_p___22 != 1 & demo_race_a_p___23 != 1 & demo_race_a_p___24 != 1 & demo_race_a_p___25 != 1 )


#Multiracial

# mutate column: true if participant marked any asian category
# mutate column: true if participant marked native american/alaska native
# sum white, black, asian, native american/alaska native, and additional races

demographics_followup_abcdmodel %>% 
  mutate_at(c(12:33), as.numeric) %>% 
  mutate(
    demo_race_asian = case_when((demo_race_a_p___18 == 1 | demo_race_a_p___19 == 1 | demo_race_a_p___20 == 1 | demo_race_a_p___21 == 1 | demo_race_a_p___22 == 1 | demo_race_a_p___23 == 1 | demo_race_a_p___24 == 1) ~ 1,
                            (demo_race_a_p___18 != 1 & demo_race_a_p___19 != 1 & demo_race_a_p___20 != 1 & demo_race_a_p___21 != 1 & demo_race_a_p___22 != 1 & demo_race_a_p___23 != 1 & demo_race_a_p___24 != 1) ~ 0),
         demo_race_native_american_alaskan = case_when((demo_race_a_p___12 ==1 | demo_race_a_p___13 == 1) ~ 1,
                                                       (demo_race_a_p___12 !=1 & demo_race_a_p___13 != 1) ~ 0),
         race_total = rowSums(across(c(demo_race_a_p___10, demo_race_a_p___11, demo_race_a_p___14, demo_race_a_p___15, demo_race_a_p___16, demo_race_a_p___17, demo_race_a_p___25, demo_race_asian, demo_race_native_american_alaskan)), na.rm=T)) %>% 
  filter(race_total > 1)


#additional races
#If the caregiver chose Native Hawaiian, Guamanian, or Samoan, Other Race, or refused to choose a racial category, the youth was placed in the “additional” race group as there were too few youth in each of these categories individually for separate analysis.

demographics_followup_abcdmodel %>% 
  filter(demo_race_a_p___10 != 1 & demo_race_a_p___11 != 1 & demo_race_a_p___12 != 1 & demo_race_a_p___13 != 1 & (demo_race_a_p___14 == 1 | demo_race_a_p___15 == 1 | demo_race_a_p___16 == 1 | demo_race_a_p___17 == 1 | demo_race_a_p___25 == 1) & demo_race_a_p___18 != 1 & demo_race_a_p___19 != 1 & demo_race_a_p___20 != 1 & demo_race_a_p___21 != 1 & demo_race_a_p___22 != 1 & demo_race_a_p___23 != 1 & demo_race_a_p___24 != 1)



```

## Rerun prediction plots
```{r}
## Baseline - Model 1
baseline_pred_mod1_plot <- ggplot(brainage_pds_baseline_combat, aes(x=truth, y=corrected_pred)) + 
  geom_jitter(color="#A1C181", alpha=.2) +
  geom_abline(a=0, b=1, color='#233D4D') +
  #geom_smooth(method=lm, color='#233D4D') +
  labs(x = "Scan/Chronological Age", y ="Predicted Age") +
  theme_classic() + 
  theme(text = element_text(size = 14))  
ggsave(filename="baseline_truth_corrected_pred_mod1_combat.png",
                          width=7, height=4, units='in', dpi=300)

baseline_gap_mod1_plot <- ggplot(brainage_pds_baseline_combat, aes(x=truth, y=corrected_gap)) + 
  geom_jitter(color="#A1C181", alpha=.2)+
  geom_smooth(method=lm, color='#233D4D') +
  labs(x = "Scan/Chronological Age", y ="Corrected Gap") +
  theme_classic() + 
  theme(text = element_text(size = 14))  
ggsave(filename="baseline_truth_corrected_gap_mod1_combat.png",
                          width=7, height=4, units='in', dpi=300)

ggarrange(baseline_pred_mod1_plot, baseline_gap_mod1_plot, 
          labels = c("A", "B"),
          ncol = 2, nrow = 1)

ggsave(filename = "pred_bias_baseline_mod1_combat.png",
                          width=10, height=5, units='in', dpi=300)

## Follow-Up - Model 1
followup_pred_mod1_plot <- ggplot(brainage_pds_followup_combat, aes(x=truth, y=corrected_pred)) + 
  geom_jitter(color="#619B8A", alpha=.2)+
  geom_abline(a=0, b=1, color='#233D4D') +
  labs(x = "Scan/Chronological Age", y ="Predicted Age") +
  theme_classic() + 
  theme(text = element_text(size = 14))  
ggsave(filename="followup_truth_corrected_pred_mod1_combat.png",
                          width=7, height=4, units='in', dpi=300)

# Age Bias - truth vs corrected gap
followup_gap_mod1_plot <- ggplot(brainage_pds_followup_combat, aes(x=truth, y=corrected_gap)) + 
  geom_jitter(color="#619B8A", alpha=.2)+
  geom_smooth(method=lm, color='#233D4D') +
  labs(x = "Scan/Chronological Age", y ="Corrected Gap") +
  theme_classic() + 
  theme(text = element_text(size = 14))  
ggsave(filename="followup_truth_corrected_gap_mod1_combat.png",
                          width=7, height=4, units='in', dpi=300)

#Panel Plots
ggarrange(baseline_pred_mod1_plot, baseline_gap_mod1_plot, followup_pred_mod1_plot, followup_gap_mod1_plot, 
          labels = c("A", "B", "C", "D"),
          ncol = 2, nrow = 2)

ggsave(filename = "pred_bias_mod1_combat.png",
                          width=10, height=10, units='in', dpi=300)



## Baseline - Model 2
baseline_pred_mod2_plot <- ggplot(abcd_brainage_pds_baseline_combat, aes(x=truth, y=corrected_pred)) + 
  geom_jitter(color="#E76F51", alpha=.25)+
  geom_abline(a=0, b=1, color='#233D4D') +
  labs(x = "Scan/Chronological Age", y ="Predicted Age") +
  theme_classic() + 
  theme(text = element_text(size = 12))  
ggsave(filename="baseline_truth_corrected_pred_mod2_combat.png",
                          width=7, height=4, units='in', dpi=300)

# Age Bias - truth vs corrected gap
baseline_gap_mod2_plot <- ggplot(abcd_brainage_pds_baseline_combat, aes(x=truth, y=corrected_gap)) + 
  geom_jitter(color="#E76F51", alpha=.25)+
  geom_smooth(method=lm, color='#233D4D') +
  labs(x = "Scan/Chronological Age", y ="Corrected Gap") +
  theme_classic() + 
  theme(text = element_text(size = 12))  
ggsave(filename="baseline_truth_corrected_gap_mod2_combat.png",
                          width=7, height=4, units='in', dpi=300)

# Follow-Up - Model 2
# '#C8A2C8', '#856088','#702963', '#800080'
followup_pred_mod2_plot <- ggplot(abcd_brainage_pds_followup_combat, aes(x=truth, y=corrected_pred)) + 
  geom_jitter(color="#856088", alpha=.25)+
  geom_abline(a=0, b=1, color='#233D4D') +
  labs(x = "Scan/Chronological Age", y ="Predicted Age") +
  theme_classic() + 
  theme(text = element_text(size = 12))  
ggsave(filename="followup_truth_corrected_pred_mod2_combat.png",
                          width=7, height=4, units='in', dpi=300)

# Age Bias - truth vs corrected gap
followup_gap_mod2_plot <- ggplot(abcd_brainage_pds_followup_combat, aes(x=truth, y=corrected_gap)) + 
  geom_jitter(color="#856088", alpha=.25)+
  geom_smooth(method=lm, color='#233D4D') +
  labs(x = "Scan/Chronological Age", y ="Corrected Gap") +
  theme_classic() + 
  theme(text = element_text(size = 12))  
ggsave(filename="followup_truth_corrected_gap_mod2_combat.png",
                          width=7, height=4, units='in', dpi=300)



#Panel Plots
ggarrange(baseline_pred_mod2_plot, baseline_gap_mod2_plot, followup_pred_mod2_plot, followup_gap_mod2_plot,
          labels = c("A", "B", "C", "D"),
          ncol = 2, nrow = 2)

ggsave(filename = "pred_bias_mod2_combat.png",
                          width=10, height=10, units='in', dpi=300)


```


# Change plot scaling - Model 1
```{r}
# figure 1 and 4, put actual and chronological on the same scale
# maybe will also need to rerun other plots too, for combat + grid plotting

# Baseline
#baseline_pred_mod1_plot <- 
ggplot(brainage_pds_baseline_combat, aes(x=truth, y=corrected_pred)) + 
  geom_jitter(color="#A1C181", alpha=.2) +
  geom_abline(a=0, b=1, color='#233D4D') +
  xlim(5, 20) + # 5, 20
  ylim(5, 20) +
  #geom_smooth(method=lm, color='#233D4D') +
  labs(x = "Scan/Chronological Age", y ="Predicted Age") +
  theme_classic() + 
  theme(text = element_text(size = 14))  
#ggsave(filename="baseline_truth_corrected_pred_mod1.png",
            #              width=7, height=4, units='in', dpi=300)


# Follow-Up
ggplot(brainage_pds_followup_combat, aes(x=truth, y=corrected_pred)) + 
  geom_jitter(color="#619B8A", alpha=.2)+
  geom_abline(a=0, b=1, color='#233D4D') +
  xlim(6, 21) + # 5, 20
  ylim(6, 21) +
  labs(x = "Scan/Chronological Age", y ="Predicted Age") +
  theme_classic() + 
  theme(text = element_text(size = 14))  

```

# Change plot scaling - Model 2
```{r}
ggplot(abcd_brainage_pds_baseline_combat, aes(x=truth, y=corrected_pred)) + 
  geom_jitter(color="#E76F51", alpha=.25)+
  geom_abline(a=0, b=1, color='#233D4D') +
  xlim(2, 18) + # 5, 20
  ylim(2, 18) +
  labs(x = "Scan/Chronological Age", y ="Predicted Age") +
  theme_classic() + 
  theme(text = element_text(size = 12))  


ggplot(abcd_brainage_pds_followup_combat, aes(x=truth, y=corrected_pred)) + 
  geom_jitter(color="#BDB5D5", alpha=.25)+
  geom_abline(a=0, b=1, color='#233D4D') +
  xlim(1, 22) + # 5, 20
  ylim(1, 22) +
  labs(x = "Scan/Chronological Age", y ="Predicted Age") +
  theme_classic() + 
  theme(text = element_text(size = 12))  
```


# Plot of model 1 & 2 prediction overlaid (baseline)
```{r}
# overlay model 1 on new predictions in fig 4

# try combining into one dataframe and then grouping by model
# mutate each dataframe to add column for model
# then rbind
both_mods_baseline <- rbind(brainage_pds_baseline_combat %>% mutate(model = 1), abcd_brainage_pds_baseline_combat %>% mutate(model = 2))

both_mods_baseline <- both_mods_baseline %>% 
  mutate(model = as.factor(model))

# Model 1 = light green "#A1C181"
# Model 2 = red "#E76F51"

ggplot(both_mods_baseline, aes(x=truth, y=corrected_pred, group=model, col=model, fill=model)) +
  geom_jitter(alpha=.2) +
  scale_color_manual(values = c("#A1C181", "#E76F51")) +
  #geom_abline(a=0, b=1, color='#233D4D') +
  #xlim(8, 15) + # 5, 20
 # ylim(8, 15) +
  #geom_smooth(method=lm, color='#233D4D') +
  labs(x = "Scan/Chronological Age", y ="Predicted Age") +
  theme_classic() + 
  theme(text = element_text(size = 14))  

ggsave(filename="model1_2_overlaid_baseline.png",
                          width=7, height=4, units='in', dpi=300)

```
# Plot of model 1 & 2 prediction overlaid (followup)
```{r}
# overlay model 1 on new predictions in fig 4

# try combining into one dataframe and then grouping by model
# mutate each dataframe to add column for model
# then rbind
both_mods_followup <- rbind(brainage_pds_followup_combat %>% mutate(model = 1), abcd_brainage_pds_followup_combat %>% mutate(model = 2))

both_mods_followup <- both_mods_followup %>% 
  mutate(model = as.factor(model))

# model 1: blue/teal "#619B8A"
# model 2 : purple "#856088"

ggplot(both_mods_followup, aes(x=truth, y=corrected_pred, group=model, col=model, fill=model)) +
  geom_jitter(alpha=.2) +
  scale_color_manual(values = c("#619B8A", "#856088")) +
  #geom_abline(a=0, b=1, color='#233D4D') +
  #xlim(8, 15) + # 5, 20
 # ylim(8, 15) +
  #geom_smooth(method=lm, color='#233D4D') +
  labs(x = "Scan/Chronological Age", y ="Predicted Age") +
  theme_classic() + 
  theme(text = element_text(size = 14))  
ggsave(filename="model1_2_overlaid_followup.png",
                          width=7, height=4, units='in', dpi=300)

```

### Rerun old figures
```{r}
# Distributions of puberty/cognition by model
#make categorical variable for puberty
#age-corrected cognition: These are presented as Standard Scores (mean=100, SD=15).
categorical_pds_baseline_combat <-  brainage_pds_baseline_combat %>% 
  mutate(youth_pds_cat=cut(youth_mean, breaks=c(-Inf, 1, 2, 3, Inf), labels=c("1","2","3", "4")),
         parent_pds_cat=cut(parent_mean, breaks=c(-Inf, 1, 2, 3, Inf), labels=c("1","2","3", "4")),
         cognition_cat=cut(nihtbx_totalcomp_uncorrected, breaks=c(-Inf, 85, 115, Inf), labels=c(">-1", "-1-1", ">1")),
         cognition_cat_small=cut(nihtbx_totalcomp_uncorrected, breaks=c(-Inf, 92, 108, Inf), labels=c(">-.5", "-.5-.5", ">.5")),
         cog_quart = cut(nihtbx_totalcomp_uncorrected, quantile(nihtbx_totalcomp_uncorrected, na.rm=T), labels=c("0-25", "25-50", "50-75", "75-100")))
#don't z-score, include more than 1 standard deviation and less than 1 standard deviation (ignore within 1 SD)

#Youth-Report Puberty
youth_pds_baseline_mod1_plot <- ggpar((categorical_pds_baseline_combat %>% 
  filter(!is.na(youth_pds_cat)) %>% 
  ggdensity(x = "corrected_gap", color= "youth_pds_cat", fill= "youth_pds_cat", add="mean", palette = c('#3E502A','#7CA352','#A1C181', '#CCDDBB'))),  #,'#526D37'
  xlab="Brain Age Gap", ylab="Density", legend.title = "Youth-Report PDS", font.legend = 8) +
  theme(text = element_text(size = 12)) 
ggsave(filename="baseline_youth_pds_mod1_combat.png",
                          width=7, height=4, units='in', dpi=300)

#Parent-Report Puberty
parent_pds_baseline_mod1_plot <- ggpar((categorical_pds_baseline_combat %>% 
  filter(!is.na(parent_pds_cat)) %>% 
ggdensity(x = "corrected_gap", color= "parent_pds_cat", fill= "parent_pds_cat", add="mean", palette = c('#3E502A','#7CA352','#A1C181', '#CCDDBB'))), 
  xlab="Brain Age Gap", ylab="Density", legend.title = "Parent-Report PDS", font.legend = 8) +
  theme(text = element_text(size = 12)) 
ggsave(filename="baseline_parent_pds_mod1_combat.png",
                          width=7, height=4, units='in', dpi=300)

#Cognition
ggpar((categorical_pds_baseline_combat %>% 
  filter(!is.na(cognition_cat) & cognition_cat!="-1-1" ) %>% 
  ggdensity(x = "corrected_gap", color= "cognition_cat", fill="cognition_cat", add="mean", palette = c('#7CA352',
 '#CCDDBB'))), xlab="Brain Age Gap", ylab="Density", legend.title = "Standardized Cognition")  +
  theme(text = element_text(size = 24)) 


ggpar((categorical_pds_baseline_combat %>% 
  filter(!is.na(cognition_cat)) %>% 
  ggdensity(x = "corrected_gap", color= "cognition_cat", fill="cognition_cat", add="mean")), xlab="Brain Age Gap", ylab="Density", legend.title = "Age-Corrected Cognition")

ggpar((categorical_pds_baseline_combat %>% 
  filter(!is.na(cognition_cat_small)) %>% 
  ggdensity(x = "corrected_gap", color= "cognition_cat_small", fill="cognition_cat_small", add="mean")), xlab="Brain Age Gap", ylab="Density", legend.title = "Age-Corrected Cognition (.5 sd")


#Cognition Quartiles
cog_baseline_mod1_plot <- ggpar((categorical_pds_baseline_combat %>% 
  filter(!is.na(cog_quart) & cog_quart!="25-50" & cog_quart!="50-75" ) %>% 
  ggdensity(x = "corrected_gap", color= "cog_quart", fill="cog_quart", add="mean", palette = c('#7CA352',
 '#CCDDBB'))), xlab="Brain Age Gap", ylab="Density", legend.title = "Cognition (Quartiles)", font.legend = 8)  +
  theme(text = element_text(size = 12)) 

ggsave(filename="baseline_cognition_mod1_combat.png",
                          width=7, height=4, units='in', dpi=300)


ggarrange(youth_pds_baseline_mod1_plot, parent_pds_baseline_mod1_plot, cog_baseline_mod1_plot, 
          labels = c("A", "B", "C"),
          ncol = 2, nrow = 2)

ggsave(filename = "distributions_baseline_mod1_combat.png",
                          width=7, height=5, units='in', dpi=300)

```
```{r}
#Youth-Report Puberty
#make categorical variable for puberty
#age-corrected cognition: These are presented as Standard Scores (mean=100, SD=15).
categorical_pds_followup_combat <-  brainage_pds_followup_combat %>% 
  mutate(youth_pds_cat=cut(youth_mean, breaks=c(-Inf, 1, 2, 3, Inf), labels=c("1","2","3", "4")),
         parent_pds_cat=cut(parent_mean, breaks=c(-Inf, 1, 2, 3, Inf), labels=c("1","2","3", "4")))

#don't z-score, include more than 1 standard deviation and less than 1 standard deviation (ignore within 1 SD)


youth_pds_followup_mod1_plot <- ggpar((categorical_pds_followup_combat %>% 
  filter(!is.na(youth_pds_cat)) %>% 
  ggdensity(x = "corrected_gap", color= "youth_pds_cat", fill= "youth_pds_cat", add="mean", palette=c('#B4D0C7','#82B0A2', '#619B8A', '#568A7B'))), 
  xlab="Brain Age Gap", ylab="Density", legend.title = "Youth-Report PDS", font.legend=8)  +
  theme(text = element_text(size = 12)) 

ggsave(filename="followup_youth_pds_mod1_combat.png",
                          width=7, height=4, units='in', dpi=300)

#Parent-Report Puberty
parent_pds_followup_mod1_plot <-ggpar((categorical_pds_followup_combat %>% 
  filter(!is.na(parent_pds_cat)) %>% 
ggdensity(x = "corrected_gap", color= "parent_pds_cat", fill= "parent_pds_cat", add="mean", palette=c('#B4D0C7','#82B0A2', '#619B8A', '#568A7B'))), 
  xlab="Brain Age Gap", ylab="Density", legend.title = "Parent-Report PDS", font.legend=8)  +
  theme(text = element_text(size = 12)) 

ggsave(filename="followup_parent_pds_mod1_combat.png",
                          width=7, height=4, units='in', dpi=300)


ggarrange(youth_pds_followup_mod1_plot, parent_pds_followup_mod1_plot, 
          labels = c("A", "B"),
          ncol = 2, nrow = 1)
ggsave(filename = "distributions_followup_mod1_combat.png",
                          width=10, height=4, units='in', dpi=300)

```

```{r}
#Youth-Report Puberty
#make categorical variable for puberty
#age-corrected cognition: These are presented as Standard Scores (mean=100, SD=15).
abcd_baseline_categorical_pds_combat <- abcd_brainage_pds_baseline_combat %>% 
  mutate(youth_pds_cat=cut(youth_mean, breaks=c(-Inf, 1, 2, 3, Inf), labels=c("1","2","3", "4")),
         parent_pds_cat=cut(parent_mean, breaks=c(-Inf, 1, 2, 3, Inf), labels=c("1","2","3", "4")),
         cognition_cat=cut(nihtbx_totalcomp_uncorrected, breaks=c(-Inf, 85, 115, Inf), labels=c(">-1", "-1-1", ">1")),
         cognition_cat_small=cut(nihtbx_totalcomp_uncorrected, breaks=c(-Inf, 92, 108, Inf), labels=c(">-.5", "-.5-.5", ">.5")),
         cog_quart = cut(nihtbx_totalcomp_uncorrected, quantile(nihtbx_totalcomp_uncorrected, na.rm=T), labels=c("0-25", "25-50", "50-75", "75-100")))

#don't z-score, include more than 1 standard deviation and less than 1 standard deviation (ignore within 1 SD)

#Youth-report puberty
youth_pds_baseline_mod2_plot <- ggpar((abcd_baseline_categorical_pds_combat %>% 
  filter(!is.na(youth_pds_cat)) %>% 
  ggdensity(x = "corrected_gap", color= "youth_pds_cat", fill= "youth_pds_cat", add="mean", palette=c('#FCCA46','#F3B5A5', '#E76F51', '#B43718'))), 
  xlab="Brain Age Gap", ylab="Density", legend.title = "Youth-Report PDS",  font.legend = 8)  +
  theme(text = element_text(size = 12)) 

ggsave(filename="baseline_youth_pds_mod2_combat.png",
                          width=7, height=4, units='in', dpi=300)

#Parent-Report Puberty
parent_pds_baseline_mod2_plot <- ggpar((abcd_baseline_categorical_pds_combat %>% 
  filter(!is.na(parent_pds_cat)) %>% 
ggdensity(x = "corrected_gap", color= "parent_pds_cat", fill= "parent_pds_cat", add="mean", palette=c('#FCCA46','#F3B5A5', '#E76F51', '#B43718'))), 
  xlab="Brain Age Gap", ylab="Density", legend.title = "Parent-Report PDS", font.legend = 8)  +
  theme(text = element_text(size = 12)) 

ggsave(filename="baseline_parent_pds_mod2_combat.png",
                          width=7, height=4, units='in', dpi=300)

ggpar((abcd_baseline_categorical_pds_combat %>% 
  filter(!is.na(cognition_cat)) %>% 
  ggdensity(x = "corrected_gap", color= "cognition_cat", fill="cognition_cat", add="mean", palette=c('#FCCA46',
 '#E76F51'))), xlab="Brain Age Gap", ylab="Density", legend.title = "Cognition (Standard Scores") +
  theme(text = element_text(size = 24)) 

ggpar((abcd_baseline_categorical_pds_combat %>% 
  filter(!is.na(cognition_cat)) %>% 
  ggdensity(x = "corrected_gap", color= "cognition_cat_small", fill="cognition_cat_small", add="mean")), xlab="Brain Age Gap", ylab="Density", legend.title = "Cognition (Standard Scores) .5 SD") +
  theme(text = element_text(size = 24)) 

#Cognition Quartiles
cog_baseline_mod2_plot <- ggpar((abcd_baseline_categorical_pds_combat %>% 
  filter(!is.na(cog_quart) & cog_quart!="25-50" & cog_quart!="50-75" ) %>% 
  ggdensity(x = "corrected_gap", color= "cog_quart", fill="cog_quart", add="mean", palette = c('#FCCA46',
 '#E76F51'))), xlab="Brain Age Gap", ylab="Density", legend.title = "Cognition (Quartiles)", font.legend = 8)  +
  theme(text = element_text(size = 12)) 
  
ggsave(filename="baseline_cognition_mod2_combat.png",
                          width=7, height=4, units='in', dpi=300)



ggarrange(youth_pds_baseline_mod2_plot, parent_pds_baseline_mod2_plot, cog_baseline_mod2_plot, 
          labels = c("A", "B", "C"),
          ncol = 2, nrow = 2)
ggsave(filename = "distributions_baseline_mod2_combat.png",
                          width=7, height=5, units='in', dpi=300)


```

```{r}



#Youth-Report Puberty
#make categorical variable for puberty
#age-corrected cognition: These are presented as Standard Scores (mean=100, SD=15).
abcd_categorical_pds_followup_combat <-  abcd_brainage_pds_followup_combat %>% 
  mutate(youth_pds_cat=cut(youth_mean, breaks=c(-Inf, 1, 2, 3, Inf), labels=c("1","2","3", "4")),
         parent_pds_cat=cut(parent_mean, breaks=c(-Inf, 1, 2, 3, Inf), labels=c("1","2","3", "4")))

#don't z-score, include more than 1 standard deviation and less than 1 standard deviation (ignore within 1 SD)


youth_pds_followup_mod2_plot <- ggpar((abcd_categorical_pds_followup_combat %>% 
  filter(!is.na(youth_pds_cat)) %>% 
  ggdensity(x = "corrected_gap", color= "youth_pds_cat", fill= "youth_pds_cat", add="mean", palette=c('#C8A2C8', '#856088','#702963', '#800080'))), 
  xlab="Brain Age Gap", ylab="Density", legend.title = "Youth-Report PDS", font.legend=8)  +
  theme(text = element_text(size = 12)) 

ggsave(filename="followup_youth_pds_mod2_combat.png",
                          width=7, height=4, units='in', dpi=300)

#Parent-Report Puberty
parent_pds_followup_mod2_plot <-ggpar((abcd_categorical_pds_followup_combat %>% 
  filter(!is.na(parent_pds_cat)) %>% 
ggdensity(x = "corrected_gap", color= "parent_pds_cat", fill= "parent_pds_cat", add="mean", palette=c('#C8A2C8', '#856088','#702963', '#800080'))), 
  xlab="Brain Age Gap", ylab="Density", legend.title = "Parent-Report PDS", font.legend=8)  +
  theme(text = element_text(size = 12)) 

ggsave(filename="followup_parent_pds_mod2_combat.png",
                          width=7, height=4, units='in', dpi=300)


ggarrange(youth_pds_followup_mod2_plot, parent_pds_followup_mod2_plot, 
          labels = c("A", "B"),
          ncol = 2, nrow = 1)
ggsave(filename = "distributions_followup_mod2_combat.png",
                          width=10, height=4, units='in', dpi=300)

```


```{r}
# Model feature - follow-up

# vip
#abcd_model_obj_combat_followup <- fit_workflow_combat_followup$fit$fit$fit

vip(fit_workflow_combat_followup, num_features = 20)

#vip(abcd_model_obj_combat_followup, num_features = 20)
#vi(fit_workflow_combat_followup$fit$fit$fit)

# ggseg

# select only name and atlas name, then join with new vip estimates to get around renaming by hand
abcd_vi_renamed <- rio::import("~/Documents/FYP/abcd_vi_renamed.csv") %>% 
  select(Variable, brain_labels_dk, label)

abcd_vi_followup <- left_join(vi(fit_workflow_combat_followup), abcd_vi_renamed)

abcd_vi_renamed_dk <- rio::import("~/Documents/FYP/abcd_vi_renamed_dk.csv") %>% 
  select(Variable, label, aseg_label)

abcd_vi_dk_followup <- left_join(vi(fit_workflow_combat_followup), abcd_vi_renamed_dk)



#check labels
brain_labels(dk)
brain_labels(aseg)


#Cortical - Volume
dk_vi_vol_followup <- abcd_vi_dk_followup %>%
  filter(grepl('Vol', Variable)) %>% 
  filter(label != "") %>% 
  select(Importance,label)

dk_vi_vol_followup <- data.frame(dk_vi_vol_followup)

ggplot(dk_vi_vol_followup) +
  geom_brain(atlas = dk, position = position_brain(hemi ~ side), aes(fill = Importance))+
  theme_void() +
  scale_fill_gradient(low = '#FDD872', high = '#E76F51') +
  labs(title = "Cortical Volume")
ggsave(filename="abcd_model_dk_vol_importance_followup.png",
                         width=8, height=4, units='in', dpi=300)


#Cortical - Area
dk_vi_area_followup <- abcd_vi_dk_followup %>%
  filter(grepl('Area', Variable)) %>% 
  filter(label != "") %>% 
  select(Importance,label)

dk_vi_area_followup <- data.frame(dk_vi_area_followup)

ggplot(dk_vi_area_followup) +
  geom_brain(atlas = dk, position = position_brain(hemi ~ side), aes(fill = Importance))+
  theme_void() +
  scale_fill_gradient(low = '#FDD872', high = '#E76F51') +
  labs(title = "Cortical Area")
ggsave(filename="abcd_model_dk_area_importance_followup.png",
                         width=8, height=4, units='in', dpi=300)




#Subcortical
aseg_vi_followup <- abcd_vi_followup %>%
  filter(label != "") %>% 
  select(Importance,label)
  
aseg_vi_followup <- data.frame(aseg_vi_followup)
  
ggplot(aseg_vi_followup) +
  geom_brain(atlas = aseg, side="coronal", aes(fill = Importance))+
  theme_void() +
  scale_fill_gradient(low = '#FDD872', high = '#E76F51')
ggsave(filename="abcd_model_aseg_importance_coronal_followup.png",
                          width=7, height=4, units='in', dpi=300)


ggplot(aseg_vi_followup) +
  geom_brain(atlas = aseg, side="sagittal", aes(fill = Importance))+
  theme_void() +
  scale_fill_gradient(low = '#FDD872', high = '#E76F51')
ggsave(filename="abcd_model_aseg_importance_sagittal_followup.png",
                          width=7, height=4, units='in', dpi=300)

```

### New longitudinal analyses ###

figure out how many baseline training v analysis are in follow-up
```{r}
# check how many from training sample are in follow-up

renamed_harmonized_mri %>% 
  filter(eventname == "2_year_follow_up_y_arm_1")  %>% 
  select(-c(eventname, mri_info_deviceserialnumber)) %>% 
  filter(src_subject_id %in% model2_features$src_subject_id)

#3,739

# check how many from analysis are in follow-up

renamed_harmonized_mri %>% 
  filter(eventname == "2_year_follow_up_y_arm_1")  %>% 
  select(-c(eventname, mri_info_deviceserialnumber)) %>% 
  filter(src_subject_id %in% model2_analysis$src_subject_id)

# 3,693


# total: 7432/7695
```

# Correlation between BrainAGE at both waves 
```{r}

# correlation for Model 1
# join baseline and follow-up corrected gaps by id
brainage_both_waves <- left_join(brainage_pds_baseline_combat %>% select(src_subject_id, corrected_pred, corrected_gap) %>% rename(baseline_pred = corrected_pred, baseline_gap = corrected_gap), brainage_pds_followup_combat %>% select(src_subject_id, corrected_pred, corrected_gap) %>% rename(followup_pred = corrected_pred, followup_gap = corrected_gap))


cor(brainage_both_waves$baseline_gap, brainage_both_waves$followup_gap, use="complete.obs")

cor.test(brainage_both_waves$baseline_gap, brainage_both_waves$followup_gap, use="complete.obs")


#correlation for abcd models
# join baseline and follow-up corrected gaps by id
brainage_abcd_both_waves <- left_join(abcd_brainage_pds_baseline_combat %>% select(src_subject_id, corrected_pred, corrected_gap) %>% rename(baseline_pred = corrected_pred, baseline_gap = corrected_gap), abcd_brainage_pds_followup_combat %>% select(src_subject_id, corrected_pred, corrected_gap) %>% rename(followup_pred = corrected_pred, followup_gap = corrected_gap))


cor(brainage_abcd_both_waves$baseline_gap, brainage_abcd_both_waves$followup_gap, use="complete.obs")

cor.test(brainage_abcd_both_waves$baseline_gap, brainage_abcd_both_waves$followup_gap, use="complete.obs")
```


ICC for BrainAGE at both waves
```{r}
# Model 1
# fit unconditional/intercept only model
icc_model_mod1 <- lmer(corrected_gap ~ 1 + (1|src_subject_id) , data = brainage_both_waves_long)

summary(icc_model_mod1)

# calculate ICC from output
# between-person variance / (between-person variance + within-person variance)
2.415 / (2.415 + 1.034)

# ABCD Model
# fit unconditional/intercept only model
icc_model_mod2 <- lmer(corrected_gap ~ 1 + (1|src_subject_id) , data = brainage_abcd_both_waves_long)

summary(icc_model_mod2)

# calculate ICC from output
# between-person variance / (between-person variance + within-person variance)
3.154 / (3.154+2.795)
```

Plot of longitudinal BrainAGE
```{r}
# Spaghetti plot, show direction of gap change
# is x-axis time, or age?
# this might just be too many points to show? maybe fit a line over the top
# vlad's model
brainage_both_waves_long <- rbind(brainage_pds_baseline_combat %>% select(src_subject_id, truth, corrected_pred, corrected_gap) %>% mutate(wave=1), brainage_pds_followup_combat %>% select(src_subject_id, truth, corrected_pred, corrected_gap)%>% mutate(wave=2)) 


ggplot(data = brainage_both_waves_long, aes(x = truth, y = corrected_gap, group = src_subject_id)) +
    geom_line(size = .2, alpha=0.4)

ggplot(data = brainage_both_waves_long, aes(x = wave, y = corrected_gap, group = src_subject_id)) +
    geom_line(size = .2, alpha=0.4)


# calculate difference, color by direction
brainage_slope_count <- brainage_both_waves_long %>%
  count(src_subject_id) %>% 
  filter(n > 1)
  
ggplot(data = brainage_both_waves_long %>% filter(src_subject_id %in% brainage_slope_count$src_subject_id) %>% 
                              group_by(src_subject_id) %>%
                mutate(slope = diff(corrected_gap)),
       aes(x = truth, y = corrected_gap, group = src_subject_id, color = slope > 0)) +
    geom_line(size = .2, alpha=0.4) +
  labs(x= "Chronological Age", y = "Corrected Gap") +
  scale_color_manual(name = "Direction of Change", labels = c("Negative", "Positive"), values = c("#E76F51",'#CCDDBB')) +
  theme_minimal()

ggsave(filename="model1_longitudinal.png",
                          width=7, height=4, units='in', dpi=300)
 
# could also facet by slope to reduce lines




# abcd model
brainage_abcd_both_waves_long <- rbind(abcd_brainage_pds_baseline_combat %>% select(src_subject_id, truth, corrected_pred, corrected_gap) %>% mutate(wave=1), abcd_brainage_pds_followup_combat %>% select(src_subject_id, truth, corrected_pred, corrected_gap)%>% mutate(wave=2)) 

ggplot(data = brainage_abcd_both_waves_long, aes(x = truth, y = corrected_gap, group = src_subject_id)) +
    geom_line(size = .2, alpha=0.4)

ggplot(data = brainage_abcd_both_waves_long, aes(x = wave, y = corrected_gap, group = src_subject_id)) +
    geom_line(size = .2, alpha=0.4)


# calculate difference, color by direction
brainage_abcd_slope_count <- brainage_abcd_both_waves_long %>%
  count(src_subject_id) %>% 
  filter(n > 1)
  
ggplot(data = brainage_abcd_both_waves_long %>% filter(src_subject_id %in% brainage_abcd_slope_count$src_subject_id) %>% 
                              group_by(src_subject_id) %>%
                mutate(slope = diff(corrected_gap)),
       aes(x = truth, y = corrected_gap, group = src_subject_id, color = slope > 0)) +
    geom_line(size = .2, alpha=0.4) +
  labs(x= "Chronological Age", y = "Corrected Gap") +
  scale_color_manual(name = "Direction of Change", labels = c("Negative", "Positive"), values = c("#E76F51",'#CCDDBB')) +
  theme_minimal()

ggsave(filename="model2_longitudinal.png",
                          width=7, height=4, units='in', dpi=300)

```

